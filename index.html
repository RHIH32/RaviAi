<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>IndusGPT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        /* Code Block Style */
        
        /* ... Baaki CSS wahi rahegi ... */
        .ai-message { white-space: pre-wrap; }
        :root { --bg-primary: #000000; --bg-secondary: #121212; --bg-tertiary: #27272a; --text-primary: #ededed; --text-secondary: #a1a1aa; --border-color: #333333; --header-bg: rgba(0, 0, 0, 0.8); }
        .light-theme { --bg-primary: #ffffff; --bg-secondary: #f3f4f6; --bg-tertiary: #e5e7eb; --text-primary: #111827; --text-secondary: #6b7280; --border-color: #e5e7eb; --header-bg: rgba(255, 255, 255, 0.8); }
        .light-theme .user-bubble { background-color: #000000 !important; color: #ffffff !important; }
        .light-theme #sidebar { background-color: #f9fafb; border-right: 1px solid #e5e7eb; }
        .light-theme #new-chat-button { background-color: #ffffff; color: #111827; border: 1px solid #d1d5db; }
        .light-theme #new-chat-button:hover { background-color: #f3f4f6; }
        .light-theme #chat-form { background-color: #ffffff; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb; }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background: var(--bg-primary); color: var(--text-primary); overflow: hidden; transition: background-color 0.3s, color 0.3s; }
        #chat-container::-webkit-scrollbar, #chat-history-list::-webkit-scrollbar { width: 6px; }
        #chat-container::-webkit-scrollbar-track, #chat-history-list::-webkit-scrollbar-track { background: var(--bg-tertiary); }
        #chat-container::-webkit-scrollbar-thumb, #chat-history-list::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 3px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Purana .message-bubble hata kar yeh naya code daalein */

.message-bubble {
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    animation: fadeIn 0.3s ease-out;
    position: relative;
}

/* --- Message Bubbles Styling --- */
        
.user-bubble {
    max-width: 85%;
    background-color: #2f2f2f; /* Dark Gray Box */
    color: #ffffff;
    margin-left: auto;
    border-radius: 12px;
}

/* AI ka message (Full width, Background HATA diya) */
.ai-bubble {
    width: 100%;
    max-width: 100%;
    background-color: transparent !important; /* Background hata diya */
    box-shadow: none !important; /* Shadow bhi hata di */
    color: var(--text-primary);
    padding: 10px 0; /* Side padding kam kar di */
}

/* --- Code Block Styling --- */
/* --- Code Block Styling Updated --- */
pre {
    background-color: #1e1e1e !important;
    border: none !important;
    border-radius: 8px;
    padding: 35px 15px 15px 15px; /* Top padding badhayi taki button ke liye jagah mile */
    overflow-x: auto;
    margin: 15px 0;
    color: #e0e0e0;
    width: 100%;
    position: relative; /* ZAROORI: Button ko set karne ke liye */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
}

/* Code Copy Button Styling */
.code-copy-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    color: #a1a1aa;
    padding: 4px 8px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.code-copy-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
}
code {
    font-family: 'Courier New', Courier, monospace;
    font-size: 14px;
    background-color: transparent !important; /* Code ke andar ka bg clean */
}
        

        .typing-indicator span, .image-loader span { height: 8px; width: 8px; background-color: var(--text-secondary); border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1), .image-loader span:nth-child(1) { animation-delay: -0.32s; } 
        .typing-indicator span:nth-child(2), .image-loader span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .mic-listening { color: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .action-button { display: inline-flex; align-items: center; margin-top: 10px; padding: 8px 14px; background-image: linear-gradient(to right, #4f46e5, #7c3aed); color: white; border-radius: 18px; font-weight: 500; text-decoration: none; transition: transform 0.2s ease; }
        .action-button:hover { transform: scale(1.05); } .action-button svg { margin-right: 8px; }
        #sidebar { transition: width 0.3s ease-in-out, padding 0.3s ease-in-out, background-color 0.3s ease-in-out; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); }
        #sidebar.collapsed { width: 0; padding: 0; overflow: hidden; }
        #login-screen, #payment-modal { background: linear-gradient(125deg, #FF9933, #FFFFFF, #138808); background-size: 400% 400%; animation: move-bg 10s ease infinite; }
        @keyframes move-bg { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        .copy-btn { position: absolute; bottom: 8px; right: 8px; background-color: rgba(0,0,0,0.2); border: none; border-radius: 50%; cursor: pointer; padding: 4px; opacity: 0.5; transition: opacity 0.2s; }
        .message-bubble:hover .copy-btn { opacity: 1; }
        .animated-text { background-image: linear-gradient(to right, #a5b4fc, #d8b4fe, #a5b4fc); background-size: 200% auto; color: transparent; -webkit-background-clip: text; background-clip: text; animation: color-change 3s linear infinite; }
        @keyframes color-change { to { background-position: 200% center; } }
        .toggle-label { display: flex; align-items: center; cursor: pointer; color: var(--text-secondary); }
        .toggle-checkbox { opacity: 0; width: 0; height: 0; }
        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 20px; background-color: var(--bg-tertiary); border-radius: 10px; transition: background-color 0.3s; }
        .toggle-switch::before { content: ''; position: absolute; width: 16px; height: 16px; border-radius: 50%; background-color: white; top: 2px; left: 2px; transition: transform 0.3s; }
        .toggle-checkbox:checked + .toggle-switch { background-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-switch::before { transform: translateX(14px); }
        #options-popover { z-index: 10; transition: opacity 0.2s ease, transform 0.2s ease; }
        #options-popover.hidden { opacity: 0; transform: translateY(10px); pointer-events: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: var(--bg-tertiary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary); }
        * { scrollbar-width: thin; scrollbar-color: var(--bg-tertiary) transparent; }


        /* --- MARKDOWN LIST FIX (Isse Points/Numbers wapas aa jayenge) --- */

/* Ordered List (1. 2. 3.) */
.message-bubble ol { 
    list-style-type: decimal !important; 
    margin-left: 25px !important; 
    margin-top: 10px !important;
    margin-bottom: 10px !important;
}

/* Unordered List (Bullets •) */
.message-bubble ul { 
    list-style-type: disc !important; 
    margin-left: 25px !important; 
    margin-top: 10px !important;
    margin-bottom: 10px !important;
}

/* List Items styling */
.message-bubble li { 
    margin-bottom: 8px !important; /* Thoda gap har point ke baad */
    padding-left: 5px;
}

/* Paragraphs ke beech gap */
.message-bubble p {
    margin-bottom: 12px !important;
}

/* Bold text ko highlight karein */
.message-bubble strong {
    font-weight: 700 !important;
    color: #ffffff !important; /* Bold text white chamkega */
}
    </style>
</head>
<body class="h-screen">

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center h-full">
        <div class="bg-white/20 backdrop-blur-sm p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4 border border-white/30">
            <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Welcome to IndusGPT</h2>
            <p class="text-gray-700 font-medium mb-6 text-center">Login to continue</p>
            <form id="login-form" class="space-y-4">
                <input type="text" id="username-input" placeholder="Your name..." class="w-full p-3 bg-white/50 border border-gray-300 rounded-lg text-gray-800 placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <input type="email" id="email-input" placeholder="Your email..." class="w-full p-3 bg-white/50 border border-gray-300 rounded-lg text-gray-800 placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <input type="password" id="password-input" placeholder="Create your password..." class="w-full p-3 bg-white/50 border border-gray-300 rounded-lg text-gray-800 placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-3 rounded-lg font-semibold shadow-lg hover:shadow-xl">Login</button>
            </form>
            <div class="my-4 flex items-center"><div class="flex-grow border-t border-gray-400"></div><span class="flex-shrink mx-4 text-gray-600">OR</span><div class="flex-grow border-t border-gray-400"></div></div>
          <div class="space-y-3">
    <button id="google-login-btn" class="w-full flex items-center justify-center p-3 bg-white text-gray-700 rounded-lg font-semibold shadow-md hover:bg-gray-100 transition-colors"><svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.563-3.373-11.127-7.962l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.021 35.596 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>Continue with Google</button>
    <button id="guest-login-btn" class="w-full p-3 bg-gray-600 text-white rounded-lg font-semibold shadow-md hover:bg-gray-700 transition-colors">Continue as Guest</button>
</div>

<div class="text-center mt-6 text-xs text-gray-600">
    <p>
        By continuing, you agree to our
        <a href="https://rhih32.github.io/link2/" target="_blank" rel="noopener noreferrer" class="font-semibold text-indigo-800 hover:underline">
            Terms of Service
        </a>
        and
        <a href="https://rhih32.github.io/link/" target="_blank" rel="noopener noreferrer" class="font-semibold text-indigo-800 hover:underline">
            Privacy Policy
        </a>.
    </p>
</div>
</div>
</div>
    
    <!-- Payment Modal -->
   


    <!-- Main App Container -->
    <div id="app-container" class="hidden h-screen w-full flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 flex-shrink-0 flex flex-col p-4">
            <div class="flex items-center justify-end mb-4 flex-shrink-0">
                <button id="collapse-sidebar-button" class="text-gray-400 hover:text-white"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
            </div>
            <div class="flex flex-col flex-grow overflow-hidden">
                <button id="new-chat-button" class="w-full flex items-center justify-center p-3 mb-2 bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg hover:opacity-80 transition-all flex-shrink-0 text-[var(--text-primary)] shadow-sm font-medium"><svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>New Chat</button>
                <div class="border-t my-2 border-color"></div>
                <!-- Search Input -->
                <div class="relative mb-2">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <input type="text" id="chat-search-input" placeholder="Search chats..." class="w-full bg-[var(--bg-tertiary)] text-[var(--text-primary)] rounded-md py-1.5 pl-9 pr-3 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
                </div>
                <h3 class="text-sm font-semibold px-2 mb-2 sidebar-subtext">Recent Chats</h3>
                <div id="chat-history-list" class="flex-1 overflow-y-auto space-y-2"></div>
                <div class="border-t my-2 border-color"></div>
                
                <!-- Privacy and Terms Links -->
                <div class="flex items-center justify-between mt-4 flex-shrink-0">
                    <button id="theme-toggle-button" class="p-2 rounded-full sidebar-button"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg></button>
                    <button id="logout-button" class="p-2 rounded-full bg-red-600 text-white hover:bg-red-700 transition-colors"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg></button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col main-content overflow-hidden">
            <!-- Header -->
           <header class="header backdrop-blur-sm p-4 pt-8 flex items-center justify-between z-10 border-b relative">
    <div class="flex items-center">
        <button id="menu-button" class="hidden mr-4"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
        <img src="logooo-removebg-preview.png" alt="IndusGPT Logo" class="h-10 w-10 rounded-full bg-white/10 p-1 object-cover">
        <h1 class="animated-text text-xl font-bold ml-2">IndusGPT</h1>
    </div>

    <div class="relative">
        <button id="header-profile-btn" class="focus:outline-none ring-2 ring-transparent hover:ring-indigo-500 rounded-full transition-all">
            <img id="header-profile-img" src="https://ui-avatars.com/api/?name=User&background=random" alt="Profile" class="h-10 w-10 rounded-full object-cover border border-gray-600">
        </button>

        <div id="header-profile-dropdown" class="hidden absolute right-0 mt-3 w-72 bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-2xl shadow-2xl z-50 overflow-hidden transform origin-top-right transition-all">
            
            <div class="p-6 text-center border-b border-[var(--border-color)] bg-[var(--bg-tertiary)]">
                <div class="relative inline-block">
                    <img id="dropdown-profile-img" src="https://ui-avatars.com/api/?name=User&background=random" class="h-20 w-20 rounded-full object-cover border-4 border-[var(--bg-secondary)] shadow-lg mx-auto">
                    <label for="profile-upload-input" class="absolute bottom-0 right-0 bg-blue-600 text-white p-1.5 rounded-full cursor-pointer hover:bg-blue-700 shadow-md transition-colors" title="Change Photo">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    </label>
                    <input type="file" id="profile-upload-input" class="hidden" accept="image/*">
                </div>
                <h3 id="dropdown-name" class="mt-3 text-lg font-bold text-[var(--text-primary)]">Guest User</h3>
                <p class="text-xs text-green-400 font-medium">Online</p>
            </div>

            <div class="p-4 space-y-3">
                <div class="flex items-center p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors">
                    <div class="bg-indigo-500/20 p-2 rounded-full mr-3 text-indigo-400">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                    </div>
                    <div>
                        <p class="text-xs text-[var(--text-secondary)]">Email</p>
                        <p id="dropdown-email" class="text-sm font-medium text-[var(--text-primary)] truncate max-w-[180px]">guest@example.com</p>
                    </div>
                </div>

                <div class="flex items-center p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors">
                    <div class="bg-purple-500/20 p-2 rounded-full mr-3 text-purple-400">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                    </div>
                    <div>
                        <p class="text-xs text-[var(--text-secondary)]">Phone</p>
                        <p id="dropdown-phone" class="text-sm font-medium text-[var(--text-primary)]">Not Added</p>
                    </div>
                </div>

                <button class="w-full mt-2 flex items-center justify-center p-2 border border-[var(--border-color)] rounded-xl hover:bg-[var(--bg-tertiary)] transition-all text-[var(--text-primary)] text-sm font-medium">
                    <svg class="h-5 w-5 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Settings
                </button>
            </div>
        </div>
    </div>
</header>

            <main id="chat-container" class="flex-1 p-4 space-y-4 overflow-y-auto"></main>

            <!-- Footer -->
            <footer class="footer backdrop-blur-sm p-0 z-20 w-full">
                
                <div id="typing-indicator" class="px-4 pb-2 hidden">
                    <div class="flex items-center">
                        <div class="bg-[var(--bg-tertiary)] p-3 rounded-2xl rounded-bl-none text-[var(--text-primary)]">
                            <div class="typing-indicator"><span></span><span></span><span></span></div>
                        </div>
                    </div>
                </div>
                
                <div id="file-preview-container" class="px-4 pb-2 hidden">
                    <div class="bg-gray-700/80 backdrop-blur text-white inline-flex items-center text-sm rounded-full px-4 py-2 shadow-lg border border-gray-600">
                        <span id="file-preview-name" class="text-xs font-medium"></span>
                        <button id="remove-file-button" class="ml-3 text-gray-300 hover:text-white bg-gray-600 rounded-full p-0.5 w-5 h-5 flex items-center justify-center">&times;</button>
                    </div>
                </div>

                <div class="p-4 w-full max-w-4xl mx-auto">
                    <form id="chat-form" class="flex items-center bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-[2rem] shadow-2xl p-2 relative transition-all duration-300 focus-within:ring-2 focus-within:ring-indigo-500/50">
                        
                        <div class="relative flex-shrink-0">
                            <button type="button" id="options-menu-button" class="p-3 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] rounded-full transition-colors">
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                            </button>
                            
                            <div id="options-popover" class="hidden absolute bottom-full mb-4 left-0 bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-2xl shadow-2xl p-2 w-56 space-y-1 overflow-hidden z-50">
                                <label for="file-input" class="w-full flex items-center p-3 hover:bg-[var(--bg-tertiary)] rounded-xl text-sm text-[var(--text-primary)] cursor-pointer transition-colors">
                                    <svg class="h-5 w-5 mr-3 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                                    <span class="font-medium">Upload File</span>
                                </label>
                                <input type="file" id="file-input" class="hidden">

                                <label for="create-image-toggle" class="flex justify-between items-center p-3 hover:bg-[var(--bg-tertiary)] rounded-xl cursor-pointer text-sm text-[var(--text-primary)] transition-colors">
                                    <span class="flex items-center">
                                        <svg class="h-5 w-5 mr-3 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <span class="font-medium">Generate Image</span>
                                    </span>
                                    <div class="relative">
                                        <input type="checkbox" id="create-image-toggle" class="toggle-checkbox">
                                        <div class="toggle-switch"></div>
                                    </div>
                                </label>

                                <label for="deep-research-toggle" class="flex justify-between items-center p-3 hover:bg-[var(--bg-tertiary)] rounded-xl cursor-pointer text-sm text-[var(--text-primary)] transition-colors">
                                    <span class="flex items-center">
                                        <svg class="h-5 w-5 mr-3 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                        <span class="font-medium">Deep Research</span>
                                    </span>
                                    <div class="relative">
                                        <input type="checkbox" id="deep-research-toggle" class="toggle-checkbox">
                                        <div class="toggle-switch"></div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <input type="text" id="user-input" placeholder="Yahan type karein ya bolein..." class="flex-1 min-w-0 bg-transparent px-4 py-3 text-[var(--text-primary)] placeholder-gray-500 focus:outline-none text-base" autocomplete="off">
                        
                        <button type="button" id="mic-button" class="p-3 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] rounded-full transition-colors mr-1">
                            </button>
                        
                        <button type="submit" id="send-button" class="p-3 bg-white text-black rounded-full shadow-lg hover:bg-gray-200 hover:scale-105 transition-all transform flex-shrink-0">
                            </button>
                    </form>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Privacy Policy Modal -->
    <div id="privacy-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-[var(--bg-secondary)] text-[var(--text-primary)] rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-[var(--border-color)] flex-shrink-0">
                <h2 class="text-xl font-bold">Privacy Policy</h2>
                <button id="close-privacy-modal" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <h3 class="font-semibold text-lg mb-2">1. Information We Collect</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">Account Information: <br>

Manual Registration: When you create an account via email, we store your name, email address, and an encrypted password.

Google Login: When you sign in with Google, we receive your name and email address from your Google account. We do not see or store your Google password.  <br><br>User Content: <br>

Prompts & Chat History: We process the questions and text prompts you provide to the AI. For your convenience, your chat history is saved in your browser's local storage.

Uploaded Files: When you upload a file (like a photo or document) for analysis, its content is sent to our AI model for processing. We do not store these files after the analysis is complete.

Generated Images: Images created from your text prompts are generated through our system. <br><br>Payment & Subscription Information: <br>

Your subscription payments are handled by our secure third-party payment partner, Razorpay. We do not store sensitive payment details like your credit card, debit card, or bank account information on our servers. We only keep a record of the payment status (successful or failed). <br><br>Technical Information: <br> We may collect certain technical information such as browser type, device information, and IP address to improve our service.</p>
                <h3 class="font-semibold text-lg mb-2">2. How We Use Information</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">To Provide and Maintain the Service: To offer you features like AI chat, image generation, and file analysis. <br><br>For Authentication: To secure your account and allow you to log in. <br><br>For Payment Processing: To manage your monthly subscription. <br><br>To Improve User Experience: To enhance the service, develop new features, and understand your needs. <br><br>For Communication: To send you important updates, security alerts, or information related to your account.</p>
                <h3 class="font-semibold text-lg mb-2">3. How We Share Information</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">We do not sell your personal information. We only share information with trusted third-party partners who help us provide the service: <br><br>Google (Firebase, Gemini): For user authentication (login) and for the AI models (text and image generation). <br><br>Razorpay: To securely process subscription payments. <br><br>All these partners adhere to their own privacy policies. We only share the information that is necessary to provide the service.</p>
                <h3 class="font-semibold text-lg mb-2">4. Data Security</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">We take the security of your data seriously. We use industry-standard security measures like encryption to protect your data from unauthorized access.</p>
                 <h3 class="font-semibold text-lg mb-2">5. Changes</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">We may update this Privacy Policy from time to time. We will notify you of any significant changes via email or an in-app notification.</p>
                 <h3 class="font-semibold text-lg mb-2">6. Your Rights and Choices</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">You can view and update the personal information associated with your account. You can clear your chat history from your browser.</p>
                  <h3 class="font-semibold text-lg mb-2">7. Contact Us</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">If you have any questions about this Privacy Policy, please contact us at [raviaiagentassistant@gmail.com].</p>
            </div>
            </div>
        </div>
    </div>

    <!-- Terms of Service Modal -->
    <div id="terms-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-[var(--bg-secondary)] text-[var(--text-primary)] rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-[var(--border-color)] flex-shrink-0">
                <h2 class="text-xl font-bold">Terms of Service</h2>
                <button id="close-terms-modal" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <p class="mb-4 text-sm text-[var(--text-secondary)]">Thank you for using the Ravi AI ("we," "our," or "us") service. By using the Service, you agree to the following terms and conditions (the "Terms of Service"). Please read them carefully.</p>
                <h3 class="font-semibold text-lg mb-2">1. Your Acceptance</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]"></p>These terms constitute a legal agreement between you and Ravi AI. If you do not agree to these terms, please do not use the Service.
                <h3 class="font-semibold text-lg mb-2">2. Service Usage</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">Eligibility: You must be at least 13 years old to use the Service. <br><br>User Accounts: You are responsible for the security of your account and for all activities that occur under it. Do not share your password with anyone. <br><br>Prohibited Use: You agree not to use this service to create or disseminate any content that is illegal, defamatory, abusive, incites violence, or infringes upon the rights of others. Using the service for spamming, hacking, or reverse-engineering is strictly prohibited.</p>
                <h3 class="font-semibold text-lg mb-2">3. Subscription and Payment</h3>
                 <p class="mb-4 text-sm text-[var(--text-secondary)]">Monthly Subscription: Ravi AI is a paid monthly subscription service. To use the Service, you must pay the subscription fee. <br><br>Payment: All payments are securely processed through our third-party payment partner, Razorpay. <br><br>Billing: Your subscription will automatically renew each month unless you cancel it. <br><br>Refunds: Subscription fees are non-refundable.</p>
                <h3 class="font-semibold text-lg mb-2">4. Content and Intellectual Property</h3>
                 <p class="mb-4 text-sm text-[var(--text-secondary)]">Your Content: You own the content you create (such as text prompts and the images generated from them). <br><br>Our Content: The Ravi AI name, logo, user interface, and all other elements of the service are our intellectual property, and their unauthorized use is prohibited.</p>
                <h3 class="font-semibold text-lg mb-2">5. Termination</h3>
                 <p class="mb-4 text-sm text-[var(--text-secondary)]">We may, at our sole discretion, suspend or terminate your account at any time and without prior notice, especially if you breach these terms.</p>
                <h3 class="font-semibold text-lg mb-2">6. Disclaimer of Warranties</h3>
                  <p class="mb-4 text-sm text-[var(--text-secondary)]">The Service is provided on an "as is" and "as available" basis. We do not guarantee its reliability, accuracy, or availability. We do not warrant that the service will always be secure, error-free, or uninterrupted.</p>
                <h3 class="font-semibold text-lg mb-2">7. Changes to Terms</h3>
                   <p class="mb-4 text-sm text-[var(--text-secondary)]">We may modify these terms at any time. When we do, we will update the "Last Updated" date on this page. Your continued use of the Service will be considered acceptance of the modified terms.</p>
                <h3 class="font-semibold text-lg mb-2">8. Contact Us</h3>
                     <p class="mb-4 text-sm text-[var(--text-secondary)]">If you have any questions about these Terms of Service, please contact us at [raviaiagentassistant@gmail.com].</p>

            </div>
        </div>
    </div>

<div id="image-viewer-modal" class="hidden fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="relative w-full max-w-4xl max-h-screen flex flex-col items-center">
        <button id="close-image-viewer" class="absolute -top-10 right-0 text-white text-3xl font-bold hover:text-gray-300">&times;</button>
        <img id="full-screen-image" src="" alt="Full Screen" class="max-w-full max-h-[80vh] object-contain rounded-lg shadow-2xl">
        <a id="download-btn-modal" class="mt-4 bg-white text-black px-6 py-2 rounded-full font-bold cursor-pointer hover:bg-gray-200">Download Image</a>
    </div>
</div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Configuration ---
        // ZAROORI: Apne Firebase project ki details yahan 
        const firebaseConfig = {
         apiKey: "AIzaSyCTvZ63pkD4C9FnfOwmlKQX1QwDDOW3680",
         authDomain: "ravi-ai-d1e8a.firebaseapp.com",
         projectId: "ravi-ai-d1e8a",
         storageBucket: "ravi-ai-d1e8a.firebasestorage.app",
         messagingSenderId: "150254318822",
         appId: "1:150254318822:web:2f78a2307404dc0ca53727",
         measurementId: "G-5HTXWMEG6M"
 };

        // Initialize Firebase
 firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();


    auth.getRedirectResult()
    .then((result) => {
        if (result && result.user) {
            // Login safal hua!
            const user = result.user;
            console.log("Redirect login successful for:", user.displayName);
            handleLogin(user.displayName, user.email);
        }
        // Agar result.user null hai to kuch nahi karna hai
    }).catch((error) => {
        // Error handle karein
        console.error("Google Redirect Login Error:", error.code, error.message);
        alert("Google login failed: " + error.message);
    });
    


// ------------------------------------------------------------------
        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username-input');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const guestLoginBtn = document.getElementById('guest-login-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutButton = document.getElementById('logout-button');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatContainer = document.getElementById('chat-container');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const micButton = document.getElementById('mic-button');
        const muteButton = document.getElementById('mute-button');
        const sidebar = document.getElementById('sidebar');
        const menuButton = document.getElementById('menu-button');
        const collapseSidebarButton = document.getElementById('collapse-sidebar-button');
        const newChatButton = document.getElementById('new-chat-button');
        const chatHistoryList = document.getElementById('chat-history-list');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const fileInput = document.getElementById('file-input');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const filePreviewName = document.getElementById('file-preview-name');
        const removeFileButton = document.getElementById('remove-file-button');
        const optionsMenuButton = document.getElementById('options-menu-button');
        const optionsPopover = document.getElementById('options-popover');
        const createImageToggle = document.getElementById('create-image-toggle');
        const deepResearchToggle = document.getElementById('deep-research-toggle');
        const chatSearchInput = document.getElementById('chat-search-input');
        // New Modal elements
      
        // --- State ---
       let conversations = {};
        let activeChatId = null;
        let currentUser = null;
        let currentUserEmail = null;
        let isMuted = false;
        let hindiVoice = null;
        let selectedFile = null; 
        let touchStartX = 0;
        let touchStartY = 0;
        let currentPlayingBtn = null;
        const swipeThreshold = 50; // Kam se kam 50px swipe karna zaroori hai
     
    // ==========================================================
// YEH FINAL AUR SAHI CODE HAI. PURAANE FUNCTIONS KI JAGAH
// IS POORE BLOCK KO PASTE KAREIN.
// ==========================================================

// Android se voice result receive karne ke liye
window.onVoiceResult = function(text) {
    console.log("Android se voice result mila:", text);
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    if (userInput && sendButton && text && text.trim().length > 0) {
        userInput.value = text;
        sendButton.click(); // Form submit karne ke liye button ko click karo
    }
};

        // ✅ ANDROID SE SIGNAL AANE PAR ICON RESET KAREGA
window.onSpeechFinished = function() {
    console.log("Android: Speaking finished.");
    
    // Agar koi button 'Stop' mode me hai, to use wapas 'Speaker' bana do
    if (currentPlayingBtn) {
        currentPlayingBtn.innerHTML = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>`;
        currentPlayingBtn = null; // Variable khali kar do
    }
};

// Jab Android mic sunna shuru kare
window.onListeningStarted = function() {
    console.log("Android ne sunna shuru kiya...");
    const micButton = document.getElementById('mic-button');
    if (micButton) {
        micButton.classList.add('mic-listening'); // Animation on
    }
};

// Jab Android mic sunna band kare
window.onListeningEnded = function() {
    console.log("Android ne sunna band kiya.");
    const micButton = document.getElementById('mic-button');
    if (micButton) {
        micButton.classList.remove('mic-listening'); // Animation off
    }
};

// Jab language pack ki samasya ho
window.showLanguagePackGuide = function() {
    alert("Hindi bhasha sunne mein samasya aa rahi hai.\n\nPhone ki settings mein jaakar 'Offline speech recognition' se Hindi (भारत) pack install karein.");
};

        

        // --- function  Initialization ---
// ==========================================================

     // --- Initialization (Fixed Version) ---
function initialize() {
    const savedUser = localStorage.getItem('ravi-ai-user');
    const savedEmail = localStorage.getItem('ravi-ai-email');
    const savedTheme = localStorage.getItem('ravi-ai-theme');
    
    // Theme load karein
    if (savedTheme) {
        document.body.classList.add(savedTheme);
    }

    // User data check karein
    if (savedUser && savedEmail) {
        currentUser = savedUser;
        currentUserEmail = savedEmail;
        
        // ZAROORI: Saved photo check karein
        const savedPhoto = localStorage.getItem('ravi-ai-profile-pic');
        
        // UI update karein taaki photo aur naam turant dikhe
        updateProfileUI(savedUser, savedEmail, savedPhoto);
        
        showChatInterface();
    } else {
        showLoginInterface();
    }
    
    setupIcons();
    setupEventListeners();
}



        // --- Profile Elements ---
const headerProfileBtn = document.getElementById('header-profile-btn');
const headerProfileDropdown = document.getElementById('header-profile-dropdown');
const profileUploadInput = document.getElementById('profile-upload-input');
const headerProfileImg = document.getElementById('header-profile-img');
const dropdownProfileImg = document.getElementById('dropdown-profile-img');
const dropdownName = document.getElementById('dropdown-name');
const dropdownEmail = document.getElementById('dropdown-email');
const dropdownPhone = document.getElementById('dropdown-phone');

// --- Updated handleLogin Function ---
// Is function ko apne purane handleLogin se replace karein
function handleLogin(username, email = 'guest@example.com', photoUrl = null) {
    currentUser = username;
    currentUserEmail = email;
    
    // LocalStorage mein save karein
    localStorage.setItem('ravi-ai-user', username);
    localStorage.setItem('ravi-ai-email', email);
    
    // Profile Update Logic
    updateProfileUI(username, email, photoUrl);
    
    showChatInterface();
}

// --- Helper Function to Update Profile UI (Fixed Version) ---
function updateProfileUI(name, email, photoUrl) {
    // 1. Name & Email Set karein
    if(dropdownName) dropdownName.textContent = name;
    if(dropdownEmail) dropdownEmail.textContent = email;
    
    // 2. Phone Number Logic (FIXED: Ab fake number nahi dikhayega)
    // LocalStorage check karega, agar wahan number nahi hai to "Not Added" dikhayega
    const storedPhone = localStorage.getItem('ravi-ai-phone');
    if (storedPhone) {
        if(dropdownPhone) dropdownPhone.textContent = storedPhone;
    } else {
        if(dropdownPhone) dropdownPhone.textContent = "Not Added";
    }

    // 3. Photo Logic (FIXED: Priority -> LocalStorage > LoginURL > Default)
    // Sabse pehle check karo ki kya user ne apni photo save ki hai?
    const localPhoto = localStorage.getItem('ravi-ai-profile-pic');
    
    // Agar local photo hai to wo use karo, nahi to default
    const finalPhoto = localPhoto || photoUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=6366f1&color=fff`;
    
    if(headerProfileImg) headerProfileImg.src = finalPhoto;
    if(dropdownProfileImg) dropdownProfileImg.src = finalPhoto;
}
// --- Event Listeners for Profile ---
// Yeh setupEventListeners function ke andar add karein

// 1. Dropdown Toggle
headerProfileBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    headerProfileDropdown.classList.toggle('hidden');
});

// 2. Click Outside to Close
document.addEventListener('click', (e) => {
    if (!headerProfileDropdown.classList.contains('hidden') && 
        !headerProfileDropdown.contains(e.target) && 
        !headerProfileBtn.contains(e.target)) {
        headerProfileDropdown.classList.add('hidden');
    }
});

// 3. Photo Upload & Save Logic
profileUploadInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const base64Image = event.target.result;
            // UI Update
            headerProfileImg.src = base64Image;
            dropdownProfileImg.src = base64Image;
            // Save to Storage
            localStorage.setItem('ravi-ai-profile-pic', base64Image);
        };
        reader.readAsDataURL(file);
    }
});

// 4. Initial Load Check (Initialize function ke andar call karein)
const savedUser = localStorage.getItem('ravi-ai-user');
const savedEmail = localStorage.getItem('ravi-ai-email');
if(savedUser) {
    updateProfileUI(savedUser, savedEmail);
}
        // --- setupIcons ---
        function setupIcons() {
            micButton.innerHTML = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>`;
            sendButton.innerHTML = `<svg class="h-6 w-6 transform rotate-90" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>`;
            optionsMenuButton.innerHTML = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6" /></svg>`;
            updateMuteButtonIcon();
        }
        
        // --- UI Switching & State ---
        function showLoginInterface() {
            loginScreen.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }

        function showChatInterface() {
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            appContainer.classList.add('flex');
            loadConversations();
            renderChatHistory();
            if (!activeChatId || !conversations[activeChatId]) {
                startNewChat();
            } else {
                loadChat(activeChatId);
            }
        }

        // --- Sidebar Logic ---
        function toggleSidebar() {
            sidebar.classList.toggle('collapsed');
            menuButton.classList.toggle('hidden');
        }
        
       
        // --- Login/Logout & Chat History ---
    function handleLogin(username, email = 'guest@example.com') {
    currentUser = username;
    currentUserEmail = email;
    localStorage.setItem('ravi-ai-user', username);
    localStorage.setItem('ravi-ai-email', email);
    
    // Nayi logic: Bina subscription check kiye seedha chat dikhao
    localStorage.setItem('ravi-ai-subscribed', 'true'); // Hum maan rahe hain ki user "subscribed" hai free tier ke liye
    
    showChatInterface(); // <-- Ise yahan badal dein
}
        function getStorageKey() { return `ravi-ai-chats-${currentUser}`; }

        function loadConversations() {
            const saved = localStorage.getItem(getStorageKey());
            conversations = saved ? JSON.parse(saved) : {};
            const chatIds = Object.keys(conversations);
            activeChatId = chatIds.length > 0 ? chatIds[chatIds.length - 1] : null;
        }

        function saveConversations() {
            if (!currentUser) return;
            localStorage.setItem(getStorageKey(), JSON.stringify(conversations));
        }

        function renderChatHistory() {
            const searchTerm = chatSearchInput.value.toLowerCase();
            chatHistoryList.innerHTML = '';
            
            const allChats = Object.values(conversations);
            const filteredChats = searchTerm 
                ? allChats.filter(chat => chat.title.toLowerCase().includes(searchTerm)) 
                : allChats;

            filteredChats.sort((a, b) => b.id.split('-')[1] - a.id.split('-')[1]).forEach(chat => {
                const itemWrapper = document.createElement('div');
                itemWrapper.className = `group p-2 rounded-lg flex items-center justify-between w-full cursor-pointer hover:bg-[var(--bg-tertiary)] transition-colors border border-transparent ${chat.id === activeChatId ? 'bg-[var(--bg-tertiary)] border-[var(--border-color)]' : ''}`;
                const itemButton = document.createElement('button');
                itemButton.className = 'flex-grow text-left truncate';
                itemButton.textContent = chat.title;
                itemButton.dataset.chatId = chat.id;
                const deleteButton = document.createElement('button');
                deleteButton.className = 'invisible group-hover:visible p-1 rounded-full hover:bg-red-500/20 ml-2 flex-shrink-0'; 
                deleteButton.innerHTML = `<svg class="h-4 w-4 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
                deleteButton.dataset.chatIdDelete = chat.id;
                itemWrapper.appendChild(itemButton);
                itemWrapper.appendChild(deleteButton);
                chatHistoryList.appendChild(itemWrapper);
            });
        }
        
        function startNewChat() {
            const newChatId = `chat-${Date.now()}`;
            activeChatId = newChatId;
            conversations[newChatId] = { id: newChatId, title: 'New Chat', messages: [] };
            loadChat(newChatId);
            renderChatHistory();
            saveConversations();
        }

      function loadChat(chatId) {
            chatContainer.innerHTML = '';
            activeChatId = chatId;
            const chat = conversations[chatId];
            
            if (chat && chat.messages.length > 0) {
                chat.messages.forEach(msg => {
                    if (msg.role === 'user') addMessageToUI('user', msg.parts[0].text);
                    else handleAIResponse(msg.parts[0].text, false, false);
                });
            } else {
                // === DYNAMIC WELCOME SCREEN (Light/Dark Compatible) ===
                
                const welcomeContainer = document.createElement('div');
                welcomeContainer.className = 'flex flex-col items-center justify-center h-full w-full px-4 mt-10 opacity-0 animate-[fadeIn_0.5s_ease-out_forwards]';
                
                // 1. Logo / Greeting
                welcomeContainer.innerHTML = `
                    <div class="mb-8 text-center">
                        <div class="bg-[var(--bg-secondary)] p-4 rounded-full inline-block mb-4 shadow-sm">
                            <img src="logooo-removebg-preview.png" alt="Logo" class="h-12 w-12 object-contain">
                        </div>
                        <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-2">Namaste, ${currentUser || 'User'}!</h2>
                        <p class="text-[var(--text-secondary)]">Main IndusGPT hoon. Aaj main aapki kya madad kar sakta hoon?</p>
                    </div>
                `;

                // 2. Suggestion Cards Grid
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-2xl';

                const suggestions = [
                    { icon: '🎨', text: 'Ek futurist car ki photo banao', sub: 'Image Generation' },
                    { icon: '📝', text: 'Leave application likh kar do', sub: 'Writing' },
                    { icon: '💻', text: 'HTML aur CSS mein calculator code', sub: 'Coding' },
                    { icon: '🧠', text: 'Black hole kya hota hai samjhao', sub: 'Knowledge' }
                ];

                suggestions.forEach(item => {
                    const card = document.createElement('button');
                    // === YAHAN MAIN CHANGE HAI ===
                    // Ab hum direct color nahi, balki variables use kar rahe hain
                    card.className = 'text-left p-4 rounded-xl border border-[var(--border-color)] bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)] transition-all shadow-sm group';
                    
                    card.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div>
                                <h3 class="font-medium text-[var(--text-primary)] text-sm mb-1">${item.text}</h3>
                                <p class="text-xs text-[var(--text-secondary)]">${item.sub}</p>
                            </div>
                            <span class="text-xl opacity-70 group-hover:scale-110 transition-transform">${item.icon}</span>
                        </div>
                    `;
                    card.onclick = () => handleSuggestionClick(item.text);
                    grid.appendChild(card);
                });

                welcomeContainer.appendChild(grid);
                chatContainer.appendChild(welcomeContainer);
            }
            renderChatHistory();
        }


        // --- Suggestion Card Click Handler ---
        function handleSuggestionClick(text) {
            const userInput = document.getElementById('user-input');
            const chatForm = document.getElementById('chat-form');
            
            // Input box mein text daal kar form submit karo
            if (userInput && chatForm) {
                userInput.value = text;
                chatForm.dispatchEvent(new Event('submit', { cancelable: true }));
            }
        }
        // --- Speech Synthesis (TTS) ---
// YEH FINAL AUR SAHI CODE HAI

const isSpeechSupported = 'speechSynthesis' in window && window.speechSynthesis !== null;
let synth;

const speakerOnIcon = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>`;
const speakerOffIcon = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l-4-4m0 4l4-4" /></svg>`;

function loadVoices() {
    if (!isSpeechSupported) return;
    const voices = synth.getVoices();
    if (!voices || voices.length === 0) return;
    hindiVoice = voices.find(v => v.lang === 'hi-IN' && v.name.includes('Google')) || voices.find(v => v.lang === 'hi-IN');
    console.log("Voices loaded. Hindi voice:", hindiVoice ? hindiVoice.name : "None");
}

// --- NEW HELPER: Text Cleaning for Better Voice ---
function cleanTextForTTS(text) {
    return text
        // 1. Code Blocks ko 'skip' karein (Pura code padhne se bachein)
        .replace(/```[\s\S]*?```/g, ' Yahan code diya gaya hai. ')
        
        // 2. Bold/Italic formatting hatayein (**text** -> text)
        .replace(/\*\*(.*?)\*\*/g, '$1')
        .replace(/\*(.*?)\*/g, '$1')
        
        // 3. URLs/Links hatayein
        .replace(/https?:\/\/\S+/g, 'link')
        
        // 4. Markdown Symbols hatayein (#, >, `) lekin Punctuation (. , ? !) rakhein
        .replace(/[#_`>]/g, '')
        
        // 5. Numbered Lists ko pause ke liye adjust karein (Example: "1." -> "Point 1.")
        // Yeh optional hai, agar simple rakhna hai to bas regex se clean karein
        
        // 6. Extra spaces aur lines ko single space karein
        .replace(/\s+/g, ' ').trim();
}

// --- UPDATED SPEAK FUNCTION ---
function speak(text) {
    if (synth) synth.cancel(); // Purana bolna band karein
    if (window.Android && typeof window.Android.stopSpeak === 'function') window.Android.stopSpeak();

    if (!text || isMuted) return;

    // Naya Cleaner Use Karein (Isme Punctuation bachegi, to voice pause legi)
    let cleanText = cleanTextForTTS(text);

    if (window.Android && typeof window.Android.speak === 'function') {
        window.Android.speak(cleanText);
    } else if (synth) {
        const utterance = new SpeechSynthesisUtterance(cleanText);
        if (hindiVoice) utterance.voice = hindiVoice;
        
        // --- Professional Settings ---
        utterance.rate = 0.9;  // Thoda dhire (Clear aur Professional lagta hai)
        utterance.pitch = 1.0; // Normal pitch (Friendly)
        
        speechSynthesis.speak(utterance);
    }
}

// --- UPDATED START AUDIO (Toggle Button ke liye) ---
function startAudio(text) {
    let cleanText = cleanTextForTTS(text);
    
    if (window.Android && typeof window.Android.speak === 'function') {
        window.Android.speak(cleanText);
    } else if (synth) {
        const utterance = new SpeechSynthesisUtterance(cleanText);
        if (hindiVoice) utterance.voice = hindiVoice;
        
        // --- Professional Settings ---
        utterance.rate = 0.9; // Speed thodi kam (Professional feel ke liye)
        
        // Jab bolna khatam ho, icon wapas badal dein
        utterance.onend = () => {
            if (currentPlayingBtn) {
                currentPlayingBtn.innerHTML = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>`;
                currentPlayingBtn = null;
            }
        };
        speechSynthesis.speak(utterance);
    }
}

// --- TOGGLE SPEECH FUNCTION (No Change needed here, but ensure it calls startAudio) ---
function toggleSpeech(text, btnElement) {
    const speakerIcon = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>`;
    const stopIcon = `<svg class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" /></svg>`;

    if (currentPlayingBtn === btnElement) {
        stopAudio();
        btnElement.innerHTML = speakerIcon;
        currentPlayingBtn = null;
        return;
    }

    if (currentPlayingBtn) {
        stopAudio();
        currentPlayingBtn.innerHTML = speakerIcon;
    }

    startAudio(text);
    btnElement.innerHTML = stopIcon;
    currentPlayingBtn = btnElement;
}

// Audio stop karne ka logic
function stopAudio() {
    // 1. Laptop ke liye
    if (synth) {
        synth.cancel();
    }

    // 2. Android Mobile ke liye (Naya function call karein)
    if (window.Android && typeof window.Android.stopSpeak === 'function') {
        window.Android.stopSpeak(); 
    }
}

function updateMuteButtonIcon() {
    if (muteButton) {
        muteButton.innerHTML = isMuted ? speakerOffIcon : speakerOnIcon;
    }
}

if (isSpeechSupported) {
    console.log("Speech Synthesis is supported.");
    synth = window.speechSynthesis;
    synth.onvoiceschanged = loadVoices;
    loadVoices();
} else {
    console.error("Speech Synthesis API is NOT supported.");
    
    // NAYA CHECK: Agar app normal browser mein hai (Android App nahi hai),
    // tabhi buttons ko hide karne ka socho.
    if (!window.Android) {
        if (muteButton) muteButton.style.display = 'none';
        if (micButton) micButton.style.display = 'none';
    }
    // Agar yeh Android App hai, to mute button ko dikhne do, kyunki
    // bolne ka kaam native code karega.
}
        // --- Speech Recognition (STT) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'hi-IN';
            recognition.interimResults = false;
            
            // Iski Jagah Yeh Naya Code Daalein 🔽
micButton.addEventListener('click', () => {
    // Pehle check karo ki yeh Android App hai ya normal browser
    if (window.Android && typeof window.Android.startListening === 'function') {
        // Agar Android App hai, to native function call karo
        window.Android.startListening();
    } else {
        // Agar normal browser hai, to web wala speech recognition chalao
        // Yeh aapka original code hai
        if (SpeechRecognition) { // Dobara check karlo ki browser support karta hai ya nahi
             micButton.classList.contains('mic-listening') ? recognition.stop() : recognition.start();
        } else {
             alert("Voice recognition is browser mein support nahi karta.");
        }
    }
});

            recognition.onstart = () => { micButton.classList.add('mic-listening'); };
            recognition.onresult = (event) => { userInput.value = event.results[0][0].transcript; chatForm.dispatchEvent(new Event('submit', { cancelable: true })); };
            recognition.onerror = (event) => { console.error("Speech recognition error:", event.error); };
            recognition.onend = () => { micButton.classList.remove('mic-listening'); };
      } else {
    // Yahan check karo ki yeh Android App to nahi hai
    if (!window.Android) {
        micButton.disabled = true; // Sirf browser mein disable karo
    }
}

        // --- Main Chat Logic ---
        function addMessageToHistory(role, text, fileInfo = null) {
            if (!activeChatId) return;
            const currentChat = conversations[activeChatId];
            const messageParts = [{ text }];
            if (fileInfo) messageParts.push({ file: { name: fileInfo.name, type: fileInfo.type } });
            currentChat.messages.push({ role, parts: messageParts });
            if (currentChat.messages.length <= 1 && role === 'user') {
                currentChat.title = text.substring(0, 25) + (text.length > 25 ? '...' : '');
                renderChatHistory();
            }
            saveConversations();
        }

      // 3rd Argument 'animate = true' add kiya hai
        async function handleAIResponse(response, shouldSpeak = true, animate = true) {
            try {
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                
                if (jsonMatch) {
                    const command = JSON.parse(jsonMatch[0]);
                    
                    // === IMAGE GENERATION FIX ===
                    if (command.action === 'generate_image') {
                        // Text dikhao (Animation tabhi jab naya message ho)
                        await addMessageToUI('model', command.response, animate);
                        
                        // Image tabhi generate karo jab animate true ho (yani abhi maangi gayi ho)
                        // History load karte waqt dubara generate nahi karega
                        if (animate) {
                            const loadingBubble = addAILoadingBubble();
                            try {
                                const base64Image = await generateImage(command.prompt);
                                renderGeneratedImage(loadingBubble, `data:image/png;base64,${base64Image}`);
                            } catch (e) {
                                loadingBubble.innerHTML = `<p class="text-red-400">Photo banane mein samasya aa gayi.</p>`;
                            }
                        }
                        return;
                    }

                    // === OTHER COMMANDS (Google, YouTube etc) ===
                    let url = '', buttonText = '', buttonIcon = '';
                    switch (command.action) {
                        case 'google':
                            url = `https://www.google.com/search?q=${encodeURIComponent(command.query)}`;
                            buttonText = 'Google par dekhein';
                            buttonIcon = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>`;
                            break;
                        case 'youtube':
                            url = `https://www.youtube.com/results?search_query=${encodeURIComponent(command.query)}`;
                            buttonText = 'YouTube par kholein';
                            buttonIcon = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                            break;
                        case 'whatsapp':
                            url = `https://wa.me/${command.number}?text=${encodeURIComponent(command.message)}`;
                            buttonText = 'WhatsApp par bhejein';
                            buttonIcon = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>`;
                            break;
                        case 'call':
                            url = `tel:${command.number}`;
                            buttonText = 'Abhi call karein';
                            buttonIcon = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>`;
                            break;
                        default: throw new Error("Unknown command");
                    }
                    
                    addMessageWithAction(command.response, buttonText, buttonIcon, url);
                    // Agar message naya hai (animate=true), tabhi bolo
                   

                } else {
                    throw new Error("No JSON");
                }

            } catch (error) {
                // === TEXT MESSAGE FIX ===
                // Yahan hum 'animate' variable pass kar rahe hain (true ya false)
                await addMessageToUI('model', response, animate); 
                
                // Agar message naya hai, tabhi bolo
               
            }
        }

        function addAILoadingBubble() {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex justify-start';
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble p-3 rounded-2xl ai-bubble';
            bubble.innerHTML = `<div class="image-loader"><span></span><span></span><span></span></div>`;
            wrapper.appendChild(bubble);
            chatContainer.appendChild(wrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return bubble;
        }
        
       // --- YEH NAYA FUNCTION PASTE KAREIN ---
        function renderGeneratedImage(bubbleElement, imageUrl) {
            bubbleElement.classList.remove('p-3');
            
            // Check karein ki ye base64 hai ya URL
            const isBase64 = imageUrl.startsWith('data:image');
            // Mobile app detection
            const isAndroidApp = window.Android && window.Android.downloadBase64Image;

            bubbleElement.innerHTML = `
                <div class="relative group cursor-pointer">
                    <img src="${imageUrl}" 
                         onclick="openImageViewer('${imageUrl}')" 
                         class="rounded-lg max-w-full h-auto border border-gray-700 shadow-lg hover:opacity-90 transition-opacity" 
                         alt="Generated image">
                    
                    <span class="absolute bottom-2 left-2 text-xs font-semibold text-white/70 pointer-events-none drop-shadow-md">IndusGPT</span>
                    
                    <button onclick="handleImageDownload('${imageUrl}')" 
                            class="absolute bottom-2 right-2 bg-black/60 hover:bg-black/80 p-2 rounded-full text-white backdrop-blur-sm transition-all" 
                            title="Download">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                    </button>
                </div>`;
        }

        // --- NAYE HELPER FUNCTIONS (Ise renderGeneratedImage ke theek neeche rakhein) ---

        // 1. Image ko bada karne ke liye (Zoom)
        window.openImageViewer = function(url) {
            const modal = document.getElementById('image-viewer-modal');
            const img = document.getElementById('full-screen-image');
            const downloadBtn = document.getElementById('download-btn-modal');
            
            if(modal && img) {
                img.src = url;
                // Download button ko bhi set karein
                downloadBtn.onclick = () => handleImageDownload(url);
                modal.classList.remove('hidden');
            }
        };

        // Modal band karne ke liye logic
        document.getElementById('close-image-viewer')?.addEventListener('click', () => {
            document.getElementById('image-viewer-modal').classList.add('hidden');
        });
        
        // Modal ke background par click karne se band ho
        document.getElementById('image-viewer-modal')?.addEventListener('click', (e) => {
            if (e.target === document.getElementById('image-viewer-modal')) {
                document.getElementById('image-viewer-modal').classList.add('hidden');
            }
        });

        // 2. Download Handle karne ke liye (Sabse Zaroori)
        window.handleImageDownload = function(url) {
            // Agar Android App hai
            if (window.Android && typeof window.Android.downloadBase64Image === 'function') {
                // Base64 string se 'data:image/png;base64,' hata kar sirf code bhejein
                const base64Code = url.split(',')[1];
                window.Android.downloadBase64Image(base64Code);
            } 
            // Agar Laptop/Browser hai
            else {
                const a = document.createElement('a');
                a.href = url;
                a.download = `IndusGPT-Image-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        };


      // --- Typewriter Effect Helper ---
async function typeWriter(element, markdownText) {
    // 1. Pehle Markdown ko HTML mein badlo
    let htmlContent = marked.parse(markdownText);

    let i = 0;
    let isTag = false;
    let currentString = "";

    // 2. Loop jo HTML Tags ko skip karke sirf text type karega
    while (i < htmlContent.length) {
        let char = htmlContent.charAt(i);

        if (char === '<') isTag = true;  // Tag shuru
        currentString += char;
        if (char === '>') isTag = false; // Tag khatam

        if (isTag) {
            i++;
            continue; // Agar tag hai to turant jodo, ruko mat
        }

        element.innerHTML = currentString;
        
        // Auto Scroll
        const chatContainer = document.getElementById("chat-container");
        if(chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;

        // Typing Speed (10ms)
        await new Promise(resolve => setTimeout(resolve, 10));
        i++;
    }

    // 3. Last mein Code Highlight karo
    element.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
    });
}

// ✅ UPDATED addMessageToUI (Full Width Code Fix)
// ✅ UPDATED addMessageToUI (With Code Copy Button)
async function addMessageToUI(sender, message, animate = false) {
    const wrapper = document.createElement('div');
    wrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} w-full mb-4`; 
    
    const bubble = document.createElement('div');

    if (sender === 'user') {
        bubble.className = 'message-bubble p-3 rounded-2xl user-bubble text-white';
    } else {
        bubble.className = 'message-bubble py-4 px-4 w-full text-[var(--text-primary)] ai-bubble';
    }
    
    wrapper.appendChild(bubble);
    document.getElementById('chat-container').appendChild(wrapper);

    // Message Content Logic
    if (sender === 'user') {
        const p = document.createElement('p');
        p.className = "leading-relaxed text-base";
        p.innerText = message;
        bubble.appendChild(p);
    } 
    else if (sender === 'model') {
        const contentDiv = document.createElement('div');
        contentDiv.className = "leading-relaxed text-base w-full overflow-hidden"; 
        bubble.appendChild(contentDiv);

        if (animate) {
            await typeWriter(contentDiv, message);
        } else {
            contentDiv.innerHTML = marked.parse(message);
            contentDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        // --- 🟢 NEW: Add Copy Button INSIDE Code Blocks ---
        contentDiv.querySelectorAll('pre').forEach(pre => {
            // Agar button pehle se nahi hai
            if (!pre.querySelector('.code-copy-btn')) {
                const btn = document.createElement('button');
                btn.className = 'code-copy-btn';
                // Copy Icon
                btn.innerHTML = `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
                
                btn.onclick = () => {
                    const code = pre.querySelector('code').innerText;
                    navigator.clipboard.writeText(code);
                    
                    // Icon change to Checkmark temporarily
                    btn.innerHTML = `<svg class="h-4 w-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
                    setTimeout(() => {
                        btn.innerHTML = `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
                    }, 2000);
                };
                
                pre.appendChild(btn);
            }
        });

        // --- BUTTONS (Global Copy + Speak for text) ---
        // Code blocks ke liye alag button hai, isliye isse sirf text ke liye rakhte hain
        if (!message.includes('```')) {
             const actionDiv = document.createElement('div');
             actionDiv.className = "flex items-center mt-2 space-x-3 pt-1";

             // Speaker
             const speakButton = document.createElement('button');
             speakButton.className = 'text-gray-400 hover:text-blue-400 transition-colors p-1 rounded-full hover:bg-gray-800/30';
             speakButton.innerHTML = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>`;
             speakButton.onclick = () => toggleSpeech(message, speakButton);
             actionDiv.appendChild(speakButton);

             // Global Copy
             const copyButton = document.createElement('button');
             copyButton.className = 'text-gray-400 hover:text-green-400 transition-colors p-1 rounded-full hover:bg-gray-800/30'; 
             copyButton.innerHTML = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
             copyButton.onclick = () => {
                navigator.clipboard.writeText(message);
                copyButton.innerHTML = `<svg class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
                setTimeout(() => copyButton.innerHTML = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`, 2000);
             };
             actionDiv.appendChild(copyButton);

             bubble.appendChild(actionDiv);
        }
    }
    
    const chatContainer = document.getElementById('chat-container');
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

  
        function addMessageWithAction(message, buttonText, buttonIcon, url) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex justify-start w-full';
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble p-3 rounded-2xl ai-bubble';
            bubble.innerHTML = `<p>${message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>`;
            const actionLink = document.createElement('a');
            actionLink.href = url;
            actionLink.target = '_blank';
            actionLink.className = 'action-button';
            actionLink.innerHTML = `${buttonIcon} ${buttonText}`;
            bubble.appendChild(actionLink);
            wrapper.appendChild(bubble);
            chatContainer.appendChild(wrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addPdfDownloadButton(bubble, content) {
            const button = document.createElement('button');
            button.innerHTML = `<svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg><span>Download PDF</span>`;
            button.className = 'action-button';
            button.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text(content.replace(/\*\*/g, ''), 10, 10);
                doc.save('IndusGPT-Roadmap.pdf');
            });
            bubble.appendChild(button);
        }

 // ✅ UPDATED getAIResponse (Force Step-by-Step Style)
            async function getAIResponse(prompt, fileData = null) {
            const systemPrompt = `You are "IndusGPT", a friendly and expressive AI assistant. Your primary language for conversation is Hinglish, and you should use emojis to make the conversation engaging.
            **Core Instructions:**
            - **Identity:** When asked about your name or creator, respond with: "Main ek IndusGPT assistant hu. Mujhe India ke developer Ravi Kumar ne banaya hai — main ek desi smart AI assistant hoon jo aapke har sawal ka jawab dene ke liye bana hoon!"
            - **Formatting:** For mathematical equations, you MUST use LaTeX formatting (e.g., $E=mc^2$). For lists or roadmaps, use markdown lists (*, -, 1.).
            - **File Analysis:** When a file is provided, analyze its content to answer the user's questions about it.
            - **Deep Research:** If the user enables "Deep Research", you MUST use your available tools to find the latest and most accurate information before answering.

         - **Real-Time Information (News, Time, Date):**
            - Jab aapse live news ya haal ki ghatnaon ke baare mein poocha jaaye, to aapko is tarah se jawaab dena hai: "Main ek AI hoon aur mere paas real-time news ka access nahi hai, lekin main aapke liye is topic par Google search kar sakta hoon. 🧐" Iske baad aapko us news topic ke liye Google Search wala JSON command zaroor dena hai.
            - Jab aapse current time ya date poochi jaaye, to aapko jawaab dena hai: "Main ek AI hoon aur aapka exact local time nahi bata sakta. Kripya apne device ki clock dekhein. 🕒" Aapko time guess karne ki koshish nahi karni hai.
            
            **Action Commands (JSON Responses):**
            If a user's request DIRECTLY maps to one of the following actions, your ENTIRE response MUST be ONLY the corresponding JSON object. Do not add any conversational text before or after the JSON.
            - **Google Search:** For requests like "search for X", "find information about Y".
              {"action": "google", "query": "[search term]", "response": "👉 Is vishay par aur jaankari ke liye yahan click karein."}
            - **YouTube Search:** For requests like "find a video about X", "show me a YouTube video of Y".
              {"action": "youtube", "query": "[search term]", "response": "👉 Is video ko dekhne ke liye yahan click karein."}
            - **WhatsApp Message:** For requests like "send a WhatsApp message to [number]".
              {"action": "whatsapp", "number": "[phone_number_with_country_code]", "message": "[message_to_send]", "response": "👉 WhatsApp par message bhejne ke liye yahan click karein."}
            - **Phone Call:** For requests like "call [number]". If the user provides a name instead of a number, you MUST ask for the number first. Do not make up numbers.
              {"action": "call", "number": "[phone_number]", "response": "👉 Call karne ke liye yahan click karein."}
            - **Image Generation:** If asked to create an image ("banao", "create", "generate image"), use this JSON: 
              {"action": "generate_image", "prompt": "[detailed image description]", "response": "Theek hai, main aapke liye yeh photo bana raha hoon... 🎨"}

            **Code Formatting:**
            When you provide code in any language (e.g., HTML, CSS, JavaScript, Python), you MUST enclose it in markdown code fences with the language specified. For example:
            \`\`\`javascript
            console.log("Hello, World!");
            \`\`\``;
            
            const currentChatHistory = conversations[activeChatId]?.messages || [];
            const userPromptParts = [{ text: prompt }];
            if (fileData) {
                userPromptParts.push({
                    inlineData: {
                        mimeType: fileData.type,
                        data: fileData.base64
                    }
                });
            }

            const apiHistory = [ ...currentChatHistory, { role: "user", parts: userPromptParts } ];
            const payload = { contents: apiHistory, systemInstruction: { parts: [{ text: systemPrompt }] } };
            const response = await fetch('https://raviai-1h96.onrender.com/api/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            if (result.text) return result.text;
            throw new Error("Invalid API response structure.");
        }

        async function generateImage(prompt) {
            const enhancedPrompt = `${prompt}, 8k, photorealistic, highly detailed, professional photography, sharp focus, cinematic lighting`;
            const payload = { prompt: enhancedPrompt };
            const response = await fetch('https://raviai-1h96.onrender.com/api/generate-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Image generation failed with status ${response.status}`);
            const result = await response.json();
            if (result.base64Image) return result.base64Image;
            throw new Error("Invalid image response structure.");
        }
        
        
        async function generateImage(prompt) {
            const enhancedPrompt = `${prompt}, 8k, photorealistic, highly detailed, professional photography, sharp focus, cinematic lighting`;
            const payload = { prompt: enhancedPrompt };
            const response = await fetch('https://raviai-1h96.onrender.com/api/generate-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Image generation failed with status ${response.status}`);
            const result = await response.json();
            if (result.base64Image) return result.base64Image;
            throw new Error("Invalid image response structure.");
        }
        
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({ base64: reader.result.split(',')[1], type: file.type, name: file.name });
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }

               // ==========================================================
// === YEH NAYA FUNCTION ADD KAREIN ===
// ==========================================================
function firebaseSignInWithToken(idToken) {
    console.log("Android se ID Token mil gaya. Ab Firebase mein sign-in kar rahe hain...");
    const credential = firebase.auth.GoogleAuthProvider.credential(idToken);
    
    auth.signInWithCredential(credential)
        .then((result) => {
            // Sign-in safal hua.
            const user = result.user;
            console.log("Firebase sign-in safal:", user.displayName);
            // Apne purane handleLogin function ko call karke chat interface dikhayein
            handleLogin(user.displayName, user.email);
        })
        .catch((error) => {
            // Error ko handle karein.
            console.error("Firebase credential sign-in mein error:", error);
            alert("Login fail ho gaya: " + error.message);
        });
}

        function setupEventListeners() {
            menuButton.addEventListener('click', toggleSidebar);
            collapseSidebarButton.addEventListener('click', toggleSidebar);
            newChatButton.addEventListener('click', startNewChat);
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = usernameInput.value.trim();
                const email = emailInput.value.trim();
                if (username && email) handleLogin(username, email);
            });
            
            guestLoginBtn.addEventListener('click', () => handleLogin('Guest'));
            
           
             googleLoginBtn.addEventListener('click', () => {
            // Check karo ki "Android" interface hai ya nahi
            if (window.Android && typeof window.Android.performGoogleSignIn === 'function') {
             // Agar hai (matlab app mein chal raha hai), toh native function call karo
             window.Android.performGoogleSignIn();
       } else {
        // Agar nahi hai (matlab browser mein chal raha hai), toh purana tareeka istemal karo
           console.log("Browser mein chal raha hai, redirect ka istemal kar rahe hain.");
           auth.signInWithRedirect(provider);
       }
         });

            logoutButton.addEventListener('click', () => {
                auth.signOut().then(() => {
                    localStorage.clear();
                    currentUser = null;
                    currentUserEmail = null;
                    conversations = {};
                    activeChatId = null;
                    showLoginInterface();
                }).catch((error) => {
                    console.error("Logout Error:", error);
                     // Fallback for local-only logout
                    localStorage.clear();
                    showLoginInterface();
                });
            });

            // ▼▼▼ YEH NAYA SWIPE LOGIC ADD KAREIN ▼▼▼

            // Poore app container par swipe detect karein
            appContainer.addEventListener('touchstart', e => {
                // Jab haath screen par rakha
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true }); // { passive: true } performance ke liye accha hai

            appContainer.addEventListener('touchend', e => {
                // Jab haath screen se uthaya
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;

                const swipeDistX = touchEndX - touchStartX;
                const swipeDistY = touchEndY - touchStartY;

                // Check karo ki yeh horizontal swipe hai (vertical scroll nahi)
                if (Math.abs(swipeDistX) > Math.abs(swipeDistY) && Math.abs(swipeDistX) > swipeThreshold) {
                    
                    // **SWIPE RIGHT (Menu Kholne ke liye)**
                    // Check karein ki swipe screen ke left edge (pehle 70px) se shuru hua
                    if (touchStartX < 70 && swipeDistX > 0 && sidebar.classList.contains('collapsed')) {
                        toggleSidebar();
                    } 
                    // **SWIPE LEFT (Menu Band karne ke liye)**
                    // Yeh swipe kahin se bhi kiya ja सकता है
                    else if (swipeDistX < 0 && !sidebar.classList.contains('collapsed')) {
                        toggleSidebar();
                    }
                }
                
                // Reset values
                touchStartX = 0;
                touchStartY = 0;
            }, { passive: true });

            // ▲▲▲ YAHAN TAK NAYA CODE ADD KAREIN ▲▲▲

            themeToggleButton.addEventListener('click', () => { document.body.classList.toggle('light-theme'); localStorage.setItem('ravi-ai-theme', document.body.classList.contains('light-theme') ? 'light-theme' : ''); });
            
            chatSearchInput.addEventListener('input', renderChatHistory);

            chatHistoryList.addEventListener('click', (e) => {
                const chatButton = e.target.closest('button[data-chat-id]');
                const deleteButton = e.target.closest('button[data-chat-id-delete]');
                if (deleteButton) {
                    const chatIdToDelete = deleteButton.dataset.chatIdDelete;
                    delete conversations[chatIdToDelete];
                    saveConversations();
                    if (activeChatId === chatIdToDelete) {
                        const remaining = Object.keys(conversations);
                        if (remaining.length > 0) loadChat(remaining[remaining.length - 1]);
                        else startNewChat();
                    }
                    renderChatHistory();
                } else if (chatButton) {
                    loadChat(chatButton.dataset.chatId);
                }
            });

            optionsMenuButton.addEventListener('click', (e) => { e.stopPropagation(); optionsPopover.classList.toggle('hidden'); });
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectedFile = file;
                    filePreviewName.textContent = file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name;
                    filePreviewContainer.classList.remove('hidden');
                    optionsPopover.classList.add('hidden');
                }
                e.target.value = null;
            });

            createImageToggle.addEventListener('change', () => {
                userInput.placeholder = createImageToggle.checked ? "Aap kya photo banwana chahte hain?" : "Yahan type karein ya bolein...";
                optionsPopover.classList.add('hidden');
            });
            
            document.addEventListener('click', (e) => {
                if (!optionsPopover.classList.contains('hidden') && !optionsPopover.contains(e.target) && !optionsMenuButton.contains(e.target)) {
                    optionsPopover.classList.add('hidden');
                }

            });

            removeFileButton.addEventListener('click', () => { selectedFile = null; filePreviewContainer.classList.add('hidden'); });

           // --- YEH NAYA CODE HAI (OLD chatForm LISTENER KO REPLACE KAREIN) ---

chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userMessage = userInput.value.trim();
    
    // Agar message khali hai aur koi file nahi hai, to ruk jao
    if (!userMessage && !selectedFile) return;

    synth?.cancel(); // Purana bolna band karo

    // --- STEP 1: KEYWORD CHECK (Gemini ko Bypass karne ke liye) ---
    // In shabdon se hum pakad lenge ki user photo maang raha hai
    const imageKeywords = [
        "image", "photo", "tasveer", "picture", "drawing", "sketch", "banao", "create", "generate", "draw"
    ];
    
    // Check karein ki kya user ne "Toggle" on kiya hai YA keyword match ho raha hai
    // Logic: Agar message me "photo" aur "banao" dono aa jaye, ya "create image" aa jaye
    const isImageRequest = createImageToggle.checked || (
        (userMessage.toLowerCase().includes("photo") || userMessage.toLowerCase().includes("image") || userMessage.toLowerCase().includes("tasveer")) &&
        (userMessage.toLowerCase().includes("banao") || userMessage.toLowerCase().includes("create") || userMessage.toLowerCase().includes("generate") || userMessage.toLowerCase().includes("dikhao"))
    );

    // --- STEP 2: IMAGE GENERATION (Direct Call - No Gemini) ---
    if (isImageRequest) {
        // UI Update
        addMessageToUI('user', userMessage);
        userInput.value = '';
        createImageToggle.checked = false; // Toggle reset kar do
        userInput.placeholder = "Yahan type karein ya bolein...";
        
        // AI ka jawaab (Fake Response taaki user ko lage AI bol raha hai)
        addMessageToUI('model', "Samajh gaya! Main aapke liye yeh shandaar photo bana raha hoon... 🎨");
        const imageBubble = addAILoadingBubble();
        
        try {
            // Direct Image API call (Gemini quota safe!)
            const base64Image = await generateImage(userMessage);
            renderGeneratedImage(imageBubble, `data:image/png;base64,${base64Image}`);
        } catch (error) {
            console.error(error);
            imageBubble.innerHTML = `<p class="text-red-400">Maaf kijiye, photo banane mein kuch samasya aa gayi.</p>`;
        }
        return; // Yahi se wapas laut jao, Gemini ke paas mat jao!
    }

    // --- STEP 3: NORMAL CHAT (Gemini Call) ---
    // Agar photo nahi maangi, tabhi Gemini ke paas jao
    addMessageToUI('user', userMessage || `Analyzing file: ${selectedFile.name}`);
    userInput.value = '';
    typingIndicator.classList.remove('hidden');
    chatContainer.scrollTop = chatContainer.scrollHeight;

    let fileData = null;
    if (selectedFile) {
        try { fileData = await readFileAsBase64(selectedFile); } 
        catch (error) {
            addMessageToUI('model', "Maaf kijiye, file padhne mein samasya aa gayi.");
            typingIndicator.classList.add('hidden');
            return;
        }
    }
    
    addMessageToHistory('user', userMessage, selectedFile ? {name: selectedFile.name, type: selectedFile.type} : null);
    selectedFile = null;
    filePreviewContainer.classList.add('hidden');

    try {
        const aiResponse = await getAIResponse(userMessage, fileData);
        addMessageToHistory('model', aiResponse);
        handleAIResponse(aiResponse);
    } catch (error) {
        console.error("Error getting AI response:", error);
        addMessageToUI('model', "Maaf kijiye, kuch takneeki samasya aa gayi hai (Quota ya Server Error).");
    } finally {
        typingIndicator.classList.add('hidden');
    }
});
            
            chatContainer.addEventListener('click', (e) => {
                const copyBtn = e.target.closest('.copy-btn');
                if (copyBtn) {
                    const textToCopy = copyBtn.closest('.message-bubble').querySelector('p').innerText;
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    copyBtn.innerHTML = `<svg class="h-4 w-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
                    setTimeout(() => {
                        copyBtn.innerHTML = `<svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
                    }, 1500);
                }
            });

            // Event listeners for modals
           
        }
         initialize();
         
    });
    </script>
</body>
</html>
