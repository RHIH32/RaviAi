<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ravi AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Razorpay Checkout Script for payments -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        :root {
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-tertiary: #374151;
            --text-primary: #f3f4f6; --text-secondary: #9ca3af; --border-color: #4b5563;
            --header-bg: rgba(17, 24, 39, 0.7);
        }
        .light-theme {
            --bg-primary: #f9fafb; --bg-secondary: #ffffff; --bg-tertiary: #f3f4f6;
            --text-primary: #1f2937; --text-secondary: #6b7280; --border-color: #d1d5db;
            --header-bg: rgba(255, 255, 255, 0.7);
        }
        body {
            font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent;
            background: var(--bg-primary); color: var(--text-primary);
            overflow: hidden; transition: background-color 0.3s, color 0.3s;
        }
        #chat-container::-webkit-scrollbar, #chat-history-list::-webkit-scrollbar { width: 6px; }
        #chat-container::-webkit-scrollbar-track, #chat-history-list::-webkit-scrollbar-track { background: var(--bg-tertiary); }
        #chat-container::-webkit-scrollbar-thumb, #chat-history-list::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 3px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-bubble { 
            max-width: 85%; 
            word-wrap: break-word; 
            overflow-wrap: break-word;
            word-break: break-word;
            animation: fadeIn 0.3s ease-out; 
            position: relative; 
        }
        .user-bubble { background-image: linear-gradient(to right, #4338ca, #6d28d9); }
        .ai-bubble { background-color: var(--bg-tertiary); color: var(--text-primary); }
        
        .typing-indicator span, .image-loader span { height: 8px; width: 8px; background-color: var(--text-secondary); border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1), .image-loader span:nth-child(1) { animation-delay: -0.32s; } 
        .typing-indicator span:nth-child(2), .image-loader span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        
        .mic-listening { color: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .action-button { display: inline-flex; align-items: center; margin-top: 10px; padding: 8px 14px; background-image: linear-gradient(to right, #4f46e5, #7c3aed); color: white; border-radius: 18px; font-weight: 500; text-decoration: none; transition: transform 0.2s ease; }
        .action-button:hover { transform: scale(1.05); } .action-button svg { margin-right: 8px; }
        
        #sidebar { 
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out, background-color 0.3s ease-in-out; 
            background-color: var(--bg-secondary); 
            border-right: 1px solid var(--border-color);
        }
        #sidebar.collapsed { 
            width: 0; 
            padding: 0; 
            overflow: hidden; 
        }

        #login-screen, #payment-modal { background: linear-gradient(125deg, #FF9933, #FFFFFF, #138808); background-size: 400% 400%; animation: move-bg 10s ease infinite; }
        @keyframes move-bg { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        
        .copy-btn { position: absolute; bottom: 8px; right: 8px; background-color: rgba(0,0,0,0.2); border: none; border-radius: 50%; cursor: pointer; padding: 4px; opacity: 0.5; transition: opacity 0.2s; }
        .message-bubble:hover .copy-btn { opacity: 1; }
        
        .animated-text { background-image: linear-gradient(to right, #a5b4fc, #d8b4fe, #a5b4fc); background-size: 200% auto; color: transparent; -webkit-background-clip: text; background-clip: text; animation: color-change 3s linear infinite; }
        @keyframes color-change { to { background-position: 200% center; } }

        .toggle-label { display: flex; align-items: center; cursor: pointer; color: var(--text-secondary); }
        .toggle-checkbox { opacity: 0; width: 0; height: 0; }
        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 20px; background-color: var(--bg-tertiary); border-radius: 10px; transition: background-color 0.3s; }
        .toggle-switch::before { content: ''; position: absolute; width: 16px; height: 16px; border-radius: 50%; background-color: white; top: 2px; left: 2px; transition: transform 0.3s; }
        .toggle-checkbox:checked + .toggle-switch { background-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-switch::before { transform: translateX(14px); }

        #options-popover {
            z-index: 10;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        #options-popover.hidden {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
        /* Code block styling */
        .code-block-wrapper {
            background-color: #0000003d;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background-color: #0000005d;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.75rem;
        }
        .code-block-header button {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }
        .code-block-header button:hover {
            color: var(--text-primary);
        }
        .code-block pre {
            padding: 0.75rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        /* No need for separate .code-block code style, Prism handles it */
    </style>
</head>
<body class="h-screen">

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center h-full">
        <div class="bg-white/20 backdrop-blur-sm p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4 border border-white/30">
            <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Welcome to Ravi AI</h2>
            <p class="text-gray-700 font-medium mb-6 text-center">Login to continue</p>
            <form id="login-form" class="space-y-4">
                <input type="text" id="username-input" placeholder="Aapka naam..." class="w-full p-3 bg-white/50 border border-gray-300 rounded-lg text-gray-800 placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <input type="email" id="email-input" placeholder="Aapka email..." class="w-full p-3 bg-white/50 border border-gray-300 rounded-lg text-gray-800 placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <input type="password" id="password-input" placeholder="Aapka password..." class="w-full p-3 bg-white/50 border border-gray-300 rounded-lg text-gray-800 placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-3 rounded-lg font-semibold shadow-lg hover:shadow-xl">Login</button>
            </form>
            <div class="my-4 flex items-center"><div class="flex-grow border-t border-gray-400"></div><span class="flex-shrink mx-4 text-gray-600">OR</span><div class="flex-grow border-t border-gray-400"></div></div>
            <div class="space-y-3">
                <button id="google-login-btn" class="w-full flex items-center justify-center p-3 bg-white text-gray-700 rounded-lg font-semibold shadow-md hover:bg-gray-100 transition-colors"><svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.563-3.373-11.127-7.962l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.021 35.596 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>Continue with Google</button>
                <button id="guest-login-btn" class="w-full p-3 bg-gray-600 text-white rounded-lg font-semibold shadow-md hover:bg-gray-700 transition-colors">Continue as Guest</button>
            </div>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div id="payment-modal" class="hidden absolute inset-0 z-50 flex items-center justify-center">
         <div class="bg-white/20 backdrop-blur-sm p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4 border border-white/30 text-gray-800">
             <h2 class="text-3xl font-bold mb-2 text-center">Monthly Subscription</h2>
             <p class="font-medium mb-6 text-center">To continue using Ravi AI, please subscribe for ‚Çπ10 per month.</p>
             <div class="space-y-3">
                 <button id="payment-button" class="w-full flex items-center justify-center p-3 bg-blue-600 text-white rounded-lg font-semibold shadow-md hover:bg-blue-700 transition-colors">Subscribe Now</button>
             </div>
             <p id="payment-error" class="text-xs text-center mt-4 text-red-500 font-bold hidden"></p>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="app-container" class="hidden h-screen w-full flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 flex-shrink-0 flex flex-col p-4">
            <div class="flex items-center justify-end mb-4 flex-shrink-0">
                <button id="collapse-sidebar-button" class="text-gray-400 hover:text-white"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
            </div>
            <div class="flex flex-col flex-grow overflow-hidden">
                <button id="new-chat-button" class="w-full flex items-center justify-center p-2 mb-2 bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors flex-shrink-0 text-white"><svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>New Chat</button>
                <div class="border-t my-2 border-color"></div>
                <!-- Search Input -->
                <div class="relative mb-2">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <input type="text" id="chat-search-input" placeholder="Search chats..." class="w-full bg-[var(--bg-tertiary)] text-[var(--text-primary)] rounded-md py-1.5 pl-9 pr-3 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
                </div>
                <h3 class="text-sm font-semibold px-2 mb-2 sidebar-subtext">Recent Chats</h3>
                <div id="chat-history-list" class="flex-1 overflow-y-auto space-y-2"></div>
                <div class="border-t my-2 border-color"></div>
                <div id="profile-section" class="p-2 rounded-lg profile-bg">
                    <h3 class="text-sm font-semibold mb-1 sidebar-subtext">Profile</h3>
                    <p id="profile-name" class="text-sm truncate sidebar-text"></p>
                    <p id="profile-email" class="text-xs truncate sidebar-subtext"></p>
                </div>
                <!-- Privacy and Terms Links -->
                <div class="border-t my-2 border-color"></div>
                <div class="space-y-1 text-sm flex-shrink-0">
                    <a href="#" id="privacy-policy-link" class="block p-2 rounded-lg hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">Privacy Policy</a>
                    <a href="#" id="terms-of-service-link" class="block p-2 rounded-lg hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">Terms of Service</a>
                </div>
                <div class="flex items-center justify-between mt-4 flex-shrink-0">
                    <button id="theme-toggle-button" class="p-2 rounded-full sidebar-button"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg></button>
                    <button id="logout-button" class="p-2 rounded-full bg-red-600 text-white hover:bg-red-700 transition-colors"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg></button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col main-content overflow-hidden">
            <!-- Header -->
            <header class="header backdrop-blur-sm p-4 flex items-center justify-between z-10 border-b">
                <div class="flex items-center">
                    <button id="menu-button" class="hidden mr-4"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                    <img src="logooo-removebg-preview.png" alt="Ravi AI Logo" class="h-10 w-10 rounded-full bg-white/10 p-1 object-cover">
                    <h1 class="animated-text text-xl font-bold ml-2">Ravi AI</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-name-display" class="font-semibold"></span>
                    <button id="mute-button"></button>
                </div>
            </header>

            <main id="chat-container" class="flex-1 p-4 space-y-4 overflow-y-auto"></main>

            <!-- Footer -->
            <footer class="footer backdrop-blur-sm p-3 border-t">
                <div id="typing-indicator" class="px-4 pb-2 hidden"><div class="flex items-center"><div class="ai-bubble p-3 rounded-2xl rounded-bl-none"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div></div>
                
                <div id="file-preview-container" class="px-4 pb-2 hidden">
                    <div class="bg-gray-700/50 dark:bg-gray-200/50 inline-flex items-center text-sm rounded-full px-3 py-1">
                        <span id="file-preview-name" class="text-xs"></span>
                        <button id="remove-file-button" class="ml-2 text-gray-400 hover:text-white">&times;</button>
                    </div>
                </div>

                <form id="chat-form" class="flex items-center input-field rounded-full p-1">
                    <div class="relative">
                        <button type="button" id="options-menu-button" class="p-2"></button>
                        <div id="options-popover" class="hidden absolute bottom-full mb-2 left-0 bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-lg shadow-xl p-2 w-48 space-y-1">
                            <label for="file-input" class="w-full flex items-center p-2 hover:bg-[var(--bg-tertiary)] rounded-md text-sm text-[var(--text-primary)] cursor-pointer">
                                <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                                <span>Add File</span>
                            </label>
                            <input type="file" id="file-input" class="hidden">

                            <label for="create-image-toggle" class="flex justify-between items-center p-2 hover:bg-[var(--bg-tertiary)] rounded-md cursor-pointer text-sm text-[var(--text-primary)]">
                                <span class="flex items-center">
                                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    <span>Create Image</span>
                                </span>
                                <div class="relative">
                                    <input type="checkbox" id="create-image-toggle" class="toggle-checkbox">
                                    <div class="toggle-switch"></div>
                                </div>
                            </label>

                            <label for="deep-research-toggle" class="flex justify-between items-center p-2 hover:bg-[var(--bg-tertiary)] rounded-md cursor-pointer text-sm text-[var(--text-primary)]">
                                <span class="flex items-center">
                                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                    <span>Deep Research</span>
                                </span>
                                <div class="relative">
                                    <input type="checkbox" id="deep-research-toggle" class="toggle-checkbox">
                                    <div class="toggle-switch"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <input type="text" id="user-input" placeholder="Yahan type karein ya bolein..." class="flex-1 min-w-0 bg-transparent px-4 py-2 focus:outline-none">
                    
                    <button type="button" id="mic-button" class="p-2"></button>
                    
                    <button type="submit" id="send-button" class="p-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-full shadow-lg"></button>
                </form>
            </footer>
        </div>
    </div>
    
    <!-- Privacy Policy Modal -->
    <div id="privacy-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-[var(--bg-secondary)] text-[var(--text-primary)] rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-[var(--border-color)] flex-shrink-0">
                <h2 class="text-xl font-bold">Privacy Policy</h2>
                <button id="close-privacy-modal" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <h3 class="font-semibold text-lg mb-2">1. Information We Collect</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">Account Information: <br>

Manual Registration: When you create an account via email, we store your name, email address, and an encrypted password.

Google Login: When you sign in with Google, we receive your name and email address from your Google account. We do not see or store your Google password.  <br><br>User Content: <br>

Prompts & Chat History: We process the questions and text prompts you provide to the AI. For your convenience, your chat history is saved in your browser's local storage.

Uploaded Files: When you upload a file (like a photo or document) for analysis, its content is sent to our AI model for processing. We do not store these files after the analysis is complete.

Generated Images: Images created from your text prompts are generated through our system. <br><br>Payment & Subscription Information: <br>

Your subscription payments are handled by our secure third-party payment partner, Razorpay. We do not store sensitive payment details like your credit card, debit card, or bank account information on our servers. We only keep a record of the payment status (successful or failed). <br><br>Technical Information: <br> We may collect certain technical information such as browser type, device information, and IP address to improve our service.</p>
                <h3 class="font-semibold text-lg mb-2">2. How We Use Information</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">To Provide and Maintain the Service: To offer you features like AI chat, image generation, and file analysis. <br><br>For Authentication: To secure your account and allow you to log in. <br><br>For Payment Processing: To manage your monthly subscription. <br><br>To Improve User Experience: To enhance the service, develop new features, and understand your needs. <br><br>For Communication: To send you important updates, security alerts, or information related to your account.</p>
                <h3 class="font-semibold text-lg mb-2">3. How We Share Information</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">We do not sell your personal information. We only share information with trusted third-party partners who help us provide the service: <br><br>Google (Firebase, Gemini): For user authentication (login) and for the AI models (text and image generation). <br><br>Razorpay: To securely process subscription payments. <br><br>All these partners adhere to their own privacy policies. We only share the information that is necessary to provide the service.</p>
                <h3 class="font-semibold text-lg mb-2">4. Data Security</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">We take the security of your data seriously. We use industry-standard security measures like encryption to protect your data from unauthorized access.</p>
                 <h3 class="font-semibold text-lg mb-2">5. Changes</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">We may update this Privacy Policy from time to time. We will notify you of any significant changes via email or an in-app notification.</p>
                 <h3 class="font-semibold text-lg mb-2">6. Your Rights and Choices</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">You can view and update the personal information associated with your account. You can clear your chat history from your browser.</p>
                  <h3 class="font-semibold text-lg mb-2">7. Contact Us</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">If you have any questions about this Privacy Policy, please contact us at [raviaiagentassistant@gmail.com].</p>
            </div>
            </div>
        </div>
    </div>

    <!-- Terms of Service Modal -->
    <div id="terms-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-[var(--bg-secondary)] text-[var(--text-primary)] rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-[var(--border-color)] flex-shrink-0">
                <h2 class="text-xl font-bold">Terms of Service</h2>
                <button id="close-terms-modal" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <p class="mb-4 text-sm text-[var(--text-secondary)]">Thank you for using the Ravi AI ("we," "our," or "us") service. By using the Service, you agree to the following terms and conditions (the "Terms of Service"). Please read them carefully.</p>
                <h3 class="font-semibold text-lg mb-2">1. Your Acceptance</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]"></p>These terms constitute a legal agreement between you and Ravi AI. If you do not agree to these terms, please do not use the Service.
                <h3 class="font-semibold text-lg mb-2">2. Service Usage</h3>
                <p class="mb-4 text-sm text-[var(--text-secondary)]">Eligibility: You must be at least 13 years old to use the Service. <br><br>User Accounts: You are responsible for the security of your account and for all activities that occur under it. Do not share your password with anyone. <br><br>Prohibited Use: You agree not to use this service to create or disseminate any content that is illegal, defamatory, abusive, incites violence, or infringes upon the rights of others. Using the service for spamming, hacking, or reverse-engineering is strictly prohibited.</p>
                <h3 class="font-semibold text-lg mb-2">3. Subscription and Payment</h3>
                 <p class="mb-4 text-sm text-[var(--text-secondary)]">Monthly Subscription: Ravi AI is a paid monthly subscription service. To use the Service, you must pay the subscription fee. <br><br>Payment: All payments are securely processed through our third-party payment partner, Razorpay. <br><br>Billing: Your subscription will automatically renew each month unless you cancel it. <br><br>Refunds: Subscription fees are non-refundable.</p>
                <h3 class="font-semibold text-lg mb-2">4. Content and Intellectual Property</h3>
                 <p class="mb-4 text-sm text-[var(--text-secondary)]">Your Content: You own the content you create (such as text prompts and the images generated from them). <br><br>Our Content: The Ravi AI name, logo, user interface, and all other elements of the service are our intellectual property, and their unauthorized use is prohibited.</p>
                <h3 class="font-semibold text-lg mb-2">5. Termination</h3>
                 <p class="mb-4 text-sm text-[var(--text-secondary)]">We may, at our sole discretion, suspend or terminate your account at any time and without prior notice, especially if you breach these terms.</p>
                <h3 class="font-semibold text-lg mb-2">6. Disclaimer of Warranties</h3>
                  <p class="mb-4 text-sm text-[var(--text-secondary)]">The Service is provided on an "as is" and "as available" basis. We do not guarantee its reliability, accuracy, or availability. We do not warrant that the service will always be secure, error-free, or uninterrupted.</p>
                <h3 class="font-semibold text-lg mb-2">7. Changes to Terms</h3>
                   <p class="mb-4 text-sm text-[var(--text-secondary)]">We may modify these terms at any time. When we do, we will update the "Last Updated" date on this page. Your continued use of the Service will be considered acceptance of the modified terms.</p>
                <h3 class="font-semibold text-lg mb-2">8. Contact Us</h3>
                     <p class="mb-4 text-sm text-[var(--text-secondary)]">If you have any questions about these Terms of Service, please contact us at [raviaiagentassistant@gmail.com].</p>

            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Configuration ---
        // ZAROORI: Apne Firebase project ki details yahan daalein
        const firebaseConfig = {
         apiKey: "AIzaSyCTvZ63pkD4C9FnfOwmlKQX1QwDDOW3680",
         authDomain: "ravi-ai-d1e8a.firebaseapp.com",
         projectId: "ravi-ai-d1e8a",
         storageBucket: "ravi-ai-d1e8a.firebasestorage.app",
         messagingSenderId: "150254318822",
         appId: "1:150254318822:web:2f78a2307404dc0ca53727",
         measurementId: "G-5HTXWMEG6M"
 };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const paymentModal = document.getElementById('payment-modal');
        const paymentButton = document.getElementById('payment-button');
        const paymentError = document.getElementById('payment-error');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username-input');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const guestLoginBtn = document.getElementById('guest-login-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const userNameDisplay = document.getElementById('user-name-display');
        const logoutButton = document.getElementById('logout-button');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatContainer = document.getElementById('chat-container');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const micButton = document.getElementById('mic-button');
        const muteButton = document.getElementById('mute-button');
        const sidebar = document.getElementById('sidebar');
        const menuButton = document.getElementById('menu-button');
        const collapseSidebarButton = document.getElementById('collapse-sidebar-button');
        const newChatButton = document.getElementById('new-chat-button');
        const chatHistoryList = document.getElementById('chat-history-list');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');
        const fileInput = document.getElementById('file-input');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const filePreviewName = document.getElementById('file-preview-name');
        const removeFileButton = document.getElementById('remove-file-button');
        const optionsMenuButton = document.getElementById('options-menu-button');
        const optionsPopover = document.getElementById('options-popover');
        const createImageToggle = document.getElementById('create-image-toggle');
        const deepResearchToggle = document.getElementById('deep-research-toggle');
        const chatSearchInput = document.getElementById('chat-search-input');
        // New Modal elements
        const privacyPolicyLink = document.getElementById('privacy-policy-link');
        const termsOfServiceLink = document.getElementById('terms-of-service-link');
        const privacyModal = document.getElementById('privacy-modal');
        const termsModal = document.getElementById('terms-modal');
        const closePrivacyModal = document.getElementById('close-privacy-modal');
        const closeTermsModal = document.getElementById('close-terms-modal');


        // --- State ---
        let conversations = {};
        let activeChatId = null;
        let isMuted = false;
        let currentUser = null;
        let currentUserEmail = null;
        let hindiVoice = null;
        let selectedFile = null; 

        // --- Initialization ---
        function initialize() {
            const savedUser = localStorage.getItem('ravi-ai-user');
            const savedEmail = localStorage.getItem('ravi-ai-email');
            const savedTheme = localStorage.getItem('ravi-ai-theme');
            const isSubscribed = localStorage.getItem('ravi-ai-subscribed');

            if (savedTheme) {
                document.body.classList.add(savedTheme);
            }

            if (savedUser && isSubscribed === 'true') {
                currentUser = savedUser;
                currentUserEmail = savedEmail;
                showChatInterface();
            } else {
                showLoginInterface();
                localStorage.clear(); // Clear all app-related storage on new session
            }
            setupIcons();
            setupEventListeners();
        }

        // --- setupIcons ---
        function setupIcons() {
            micButton.innerHTML = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>`;
            sendButton.innerHTML = `<svg class="h-6 w-6 transform rotate-90" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>`;
            optionsMenuButton.innerHTML = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6" /></svg>`;
            updateMuteButtonIcon();
        }
        
        // --- UI Switching & State ---
        function showLoginInterface() {
            loginScreen.classList.remove('hidden');
            appContainer.classList.add('hidden');
            paymentModal.classList.add('hidden');
        }
        
        function showPaymentInterface() {
            loginScreen.classList.add('hidden');
            paymentModal.classList.remove('hidden');
            paymentModal.classList.add('flex');
        }

        function showChatInterface() {
            userNameDisplay.textContent = `Hi, ${currentUser}!`;
            profileName.textContent = currentUser;
            profileEmail.textContent = currentUserEmail;
            loginScreen.classList.add('hidden');
            paymentModal.classList.add('hidden');
            appContainer.classList.remove('hidden');
            appContainer.classList.add('flex');
            loadConversations();
            renderChatHistory();
            if (!activeChatId || !conversations[activeChatId]) {
                startNewChat();
            } else {
                loadChat(activeChatId);
            }
        }

        // --- Sidebar Logic ---
        function toggleSidebar() {
            sidebar.classList.toggle('collapsed');
            menuButton.classList.toggle('hidden');
        }
        
        // --- Payment Logic ---
        async function handlePayment() {
            paymentButton.disabled = true;
            paymentButton.textContent = 'Processing...';
            paymentError.classList.add('hidden');

            try {
                // 1. Create subscription on the server
                const subRes = await fetch('https://ravi-ai-i6h0.onrender.com/api/create-subscription', { method: 'POST' });
                if (!subRes.ok) throw new Error('Could not create subscription on the server.');
                const subData = await subRes.json();
                
                const options = {
                    key: subData.keyId,
                    subscription_id: subData.subscriptionId,
                    name: "Ravi AI",
                    description: "Monthly Subscription",
                    image: "https://raw.githubusercontent.com/RaviR‡§Ç‡§ú‡§®/Ravi-AI/main/logooo-removebg-preview.png",
                    handler: async function (response) {
                        // 2. Verify payment signature on the server
                        const verificationRes = await fetch('https://ravi-ai-i6h0.onrender.com/api/verify-payment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_subscription_id: response.razorpay_subscription_id, 
                                razorpay_signature: response.razorpay_signature,
                            }),
                        });

                        const verificationData = await verificationRes.json();
                        if (verificationData.status === 'success') {
                            localStorage.setItem('ravi-ai-subscribed', 'true');
                            showChatInterface();
                        } else {
                            throw new Error('Payment verification failed.');
                        }
                    },
                    prefill: {
                        name: currentUser,
                        email: currentUserEmail,
                    },
                    theme: {
                        color: "#4f46e5"
                    }
                };
                
                const rzp = new Razorpay(options);
                rzp.on('payment.failed', function (response) {
                    console.error(response.error);
                    paymentError.textContent = `Payment failed: ${response.error.description}. Please try again.`;
                    paymentError.classList.remove('hidden');
                    paymentButton.disabled = false;
                    paymentButton.textContent = 'Subscribe Now';
                });
                
                rzp.open();

            } catch (error) {
                console.error("Payment Error:", error);
                paymentError.textContent = "An error occurred connecting to the payment gateway. Please try again later.";
                paymentError.classList.remove('hidden');
                paymentButton.disabled = false;
                paymentButton.textContent = 'Subscribe Now';
            }
        }


        // --- Login/Logout & Chat History ---
        function handleLogin(username, email = 'guest@example.com') {
            currentUser = username;
            currentUserEmail = email;
            localStorage.setItem('ravi-ai-user', username);
            localStorage.setItem('ravi-ai-email', email);
            showPaymentInterface();
        }

        function getStorageKey() { return `ravi-ai-chats-${currentUser}`; }

        function loadConversations() {
            const saved = localStorage.getItem(getStorageKey());
            conversations = saved ? JSON.parse(saved) : {};
            const chatIds = Object.keys(conversations);
            activeChatId = chatIds.length > 0 ? chatIds[chatIds.length - 1] : null;
        }

        function saveConversations() {
            if (!currentUser) return;
            localStorage.setItem(getStorageKey(), JSON.stringify(conversations));
        }

        function renderChatHistory() {
            const searchTerm = chatSearchInput.value.toLowerCase();
            chatHistoryList.innerHTML = '';
            
            const allChats = Object.values(conversations);
            const filteredChats = searchTerm 
                ? allChats.filter(chat => chat.title.toLowerCase().includes(searchTerm)) 
                : allChats;

            filteredChats.sort((a, b) => b.id.split('-')[1] - a.id.split('-')[1]).forEach(chat => {
                const itemWrapper = document.createElement('div');
                itemWrapper.className = `group p-2 rounded-lg flex items-center justify-between w-full cursor-pointer hover:bg-gray-700 ${chat.id === activeChatId ? 'bg-indigo-500' : ''}`;
                const itemButton = document.createElement('button');
                itemButton.className = 'flex-grow text-left truncate';
                itemButton.textContent = chat.title;
                itemButton.dataset.chatId = chat.id;
                const deleteButton = document.createElement('button');
                deleteButton.className = 'invisible group-hover:visible p-1 rounded-full hover:bg-red-500/20 ml-2 flex-shrink-0'; 
                deleteButton.innerHTML = `<svg class="h-4 w-4 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
                deleteButton.dataset.chatIdDelete = chat.id;
                itemWrapper.appendChild(itemButton);
                itemWrapper.appendChild(deleteButton);
                chatHistoryList.appendChild(itemWrapper);
            });
        }
        
        function startNewChat() {
            const newChatId = `chat-${Date.now()}`;
            activeChatId = newChatId;
            conversations[newChatId] = { id: newChatId, title: 'New Chat', messages: [] };
            loadChat(newChatId);
            renderChatHistory();
            saveConversations();
        }

        function loadChat(chatId) {
            chatContainer.innerHTML = '';
            activeChatId = chatId;
            const chat = conversations[chatId];
            if (chat && chat.messages.length > 0) {
                chat.messages.forEach(msg => {
                    if (msg.role === 'user') addMessageToUI('user', msg.parts[0].text);
                    else handleAIResponse(msg.parts[0].text, false);
                });
            } else {
                const welcomeMsg = `‚ú® Namaste ${currentUser} üôè! Main aapka Ravi AI Assistant hoon. Bataaiye, main aaj aapki kis tarah help kar sakta hoon? üòä`;
                addMessageToUI('model', welcomeMsg);
            }
            renderChatHistory();
        }

        // --- Speech Synthesis (TTS) ---
        const synth = window.speechSynthesis;
        const speakerOnIcon = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>`;
        const speakerOffIcon = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l-4-4m0 4l4-4" /></svg>`;
        
        function loadVoices() {
            const voices = synth.getVoices();
            hindiVoice = voices.find(v => v.lang === 'hi-IN' && v.name.includes('Google')) || voices.find(v => v.lang === 'hi-IN');
        }
        loadVoices();
        if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = loadVoices;

        function speak(text) {
            if (isMuted || !text) return;
            synth.cancel();
            const emojiRegex = /([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g;
            const cleanText = text.replace(emojiRegex, '').replace(/\*\*(.*?)\*\*/g, '$1').replace(/\*(.*?)\*/g, '$1').replace(/_ /g, ' ');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            if (hindiVoice) utterance.voice = hindiVoice;
            utterance.lang = 'hi-IN';
            synth.speak(utterance);
        }
        
        function updateMuteButtonIcon() { muteButton.innerHTML = isMuted ? speakerOffIcon : speakerOnIcon; }

        // --- Speech Recognition (STT) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'hi-IN';
            recognition.interimResults = false;
            micButton.addEventListener('click', () => micButton.classList.contains('mic-listening') ? recognition.stop() : recognition.start());
            recognition.onstart = () => { micButton.classList.add('mic-listening'); };
            recognition.onresult = (event) => { userInput.value = event.results[0][0].transcript; chatForm.dispatchEvent(new Event('submit', { cancelable: true })); };
            recognition.onerror = (event) => { console.error("Speech recognition error:", event.error); };
            recognition.onend = () => { micButton.classList.remove('mic-listening'); };
        } else { micButton.disabled = true; }

        // --- Main Chat Logic ---
        function addMessageToHistory(role, text, fileInfo = null) {
            if (!activeChatId) return;
            const currentChat = conversations[activeChatId];
            const messageParts = [{ text }];
            if (fileInfo) messageParts.push({ file: { name: fileInfo.name, type: fileInfo.type } });
            currentChat.messages.push({ role, parts: messageParts });
            if (currentChat.messages.length <= 1 && role === 'user') {
                currentChat.title = text.substring(0, 25) + (text.length > 25 ? '...' : '');
                renderChatHistory();
            }
            saveConversations();
        }

        async function handleAIResponse(response, shouldSpeak = true) {
             try {
                // Use a regex to find a JSON object within the response string. This is more robust.
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error("No JSON object found in the response.");
                }

                const command = JSON.parse(jsonMatch[0]);
                let url = '', buttonText = '', buttonIcon = '';
                
                if (command.action === 'generate_image') {
                    addMessageToUI('model', command.response);
                    const loadingBubble = addAILoadingBubble();
                    try {
                        const base64Image = await generateImage(command.prompt);
                        renderGeneratedImage(loadingBubble, `data:image/png;base64,${base64Image}`);
                    } catch (e) {
                        loadingBubble.innerHTML = `<p class="text-red-400">Photo banane mein samasya aa gayi. üòî</p>`;
                    }
                    return;
                }

                switch (command.action) {
                    case 'google':
                        url = `https://www.google.com/search?q=${encodeURIComponent(command.query)}`;
                        buttonText = 'Google par dekhein';
                        buttonIcon = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>`;
                        break;
                    case 'youtube':
                        url = `https://www.youtube.com/results?search_query=${encodeURIComponent(command.query)}`;
                        buttonText = 'YouTube par kholein';
                        buttonIcon = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                        break;
                    case 'whatsapp':
                        url = `https://wa.me/${command.number}?text=${encodeURIComponent(command.message)}`;
                        buttonText = 'WhatsApp par bhejein';
                        buttonIcon = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>`;
                        break;
                    case 'call':
                        url = `tel:${command.number}`;
                        buttonText = 'Abhi call karein';
                        buttonIcon = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>`;
                        break;
                    default: throw new Error("Unknown command in JSON.");
                }
                addMessageWithAction(command.response, buttonText, buttonIcon, url);
                if (shouldSpeak) speak(command.response);

            } catch (error) {
                // If no JSON is found or parsing fails, treat it as a regular message.
                addMessageToUI('model', response);
                if (shouldSpeak) speak(response.replace(/```[\s\S]*?```/g, '').replace(/\$\$(.*?)\$\$|\$(.*?)\$/g, ''));
            }
        }

        function addAILoadingBubble() {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex justify-start';
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble p-3 rounded-2xl ai-bubble';
            bubble.innerHTML = `<div class="image-loader"><span></span><span></span><span></span></div>`;
            wrapper.appendChild(bubble);
            chatContainer.appendChild(wrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return bubble;
        }
        
        function renderGeneratedImage(bubbleElement, imageUrl) {
            bubbleElement.classList.remove('p-3');
            bubbleElement.innerHTML = `<div class="relative group"><img src="${imageUrl}" class="rounded-lg max-w-full h-auto" alt="Generated image"><span class="absolute bottom-2 left-2 text-xs font-semibold text-white/50 pointer-events-none">Ravi AI</span><a href="${imageUrl}" download="Ravi-AI-Image-${Date.now()}.png" class="absolute bottom-2 right-2 bg-black/50 p-2 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" title="Download Image"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></a></div>`;
        }

        function addMessageToUI(sender, message) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} w-full`;
            const bubble = document.createElement('div');
            bubble.className = `message-bubble p-3 rounded-2xl ${sender === 'user' ? 'user-bubble text-white' : 'ai-bubble'}`;
            
            const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
            let lastIndex = 0;
            let match;

            while ((match = codeBlockRegex.exec(message)) !== null) {
                const textBefore = message.substring(lastIndex, match.index);
                if (textBefore.trim()) {
                    const p = document.createElement('p');
                    p.innerHTML = textBefore.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    bubble.appendChild(p);
                }

                const language = match[1] || 'text';
                const code = match[2].trim();
                
                const preWrapper = document.createElement('div');
                preWrapper.className = 'code-block-wrapper';

                const preHeader = document.createElement('div');
                preHeader.className = 'code-block-header';
                
                const langSpan = document.createElement('span');
                langSpan.textContent = language;
                
                const copyCodeBtn = document.createElement('button');
                copyCodeBtn.innerHTML = `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><span>Copy code</span>`;
                copyCodeBtn.onclick = () => {
                    const textArea = document.createElement('textarea');
                    textArea.value = code;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    copyCodeBtn.innerHTML = `<span>Copied!</span>`;
                    setTimeout(() => {
                       copyCodeBtn.innerHTML = `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><span>Copy code</span>`;
                    }, 2000);
                };

                preHeader.appendChild(langSpan);
                preHeader.appendChild(copyCodeBtn);

                const preContainer = document.createElement('div');
                preContainer.className = 'code-block';
                const pre = document.createElement('pre');
                const codeEl = document.createElement('code');
                codeEl.className = 'language-' + language;
                codeEl.textContent = code;
                pre.appendChild(codeEl);
                preContainer.appendChild(pre);
                
                preWrapper.appendChild(preHeader);
                preWrapper.appendChild(preContainer);
                bubble.appendChild(preWrapper);

                lastIndex = codeBlockRegex.lastIndex;
            }

            const textAfter = message.substring(lastIndex);
            if (textAfter.trim()) {
                const p = document.createElement('p');
                p.innerHTML = textAfter.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                bubble.appendChild(p);
            }

            if (sender === 'model' && !/```/g.test(message)) {
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-btn';
                copyButton.innerHTML = `<svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
                bubble.appendChild(copyButton);

                if (/^\s*(\*|-|\d+\.)\s/m.test(message)) {
                    addPdfDownloadButton(bubble, message);
                }
            }

            wrapper.appendChild(bubble);
            chatContainer.appendChild(wrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            if (window.MathJax) MathJax.typesetPromise([bubble]);
            if (window.Prism) Prism.highlightAllUnder(bubble);
        }

        function addMessageWithAction(message, buttonText, buttonIcon, url) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex justify-start w-full';
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble p-3 rounded-2xl ai-bubble';
            bubble.innerHTML = `<p>${message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>`;
            const actionLink = document.createElement('a');
            actionLink.href = url;
            actionLink.target = '_blank';
            actionLink.className = 'action-button';
            actionLink.innerHTML = `${buttonIcon} ${buttonText}`;
            bubble.appendChild(actionLink);
            wrapper.appendChild(bubble);
            chatContainer.appendChild(wrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addPdfDownloadButton(bubble, content) {
            const button = document.createElement('button');
            button.innerHTML = `<svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg><span>Download PDF</span>`;
            button.className = 'action-button';
            button.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text(content.replace(/\*\*/g, ''), 10, 10);
                doc.save('Ravi-AI-Roadmap.pdf');
            });
            bubble.appendChild(button);
        }

        async function getAIResponse(prompt, fileData = null) {
            const systemPrompt = `You are "Ravi AI", a friendly and expressive AI assistant. Your primary language for conversation is Hinglish, and you should use emojis to make the conversation engaging.
            **Core Instructions:**
            - **Identity:** When asked about your name or creator, respond with: "Main Ravi AI assistant hu. Ravi ne mujhe banaya hai."
            - **Formatting:** For mathematical equations, you MUST use LaTeX formatting (e.g., $E=mc^2$). For lists or roadmaps, use markdown lists (*, -, 1.).
            - **File Analysis:** When a file is provided, analyze its content to answer the user's questions about it.
            - **Deep Research:** If the user enables "Deep Research", you MUST use your available tools to find the latest and most accurate information before answering.
            
            **Action Commands (JSON Responses):**
            If a user's request DIRECTLY maps to one of the following actions, your ENTIRE response MUST be ONLY the corresponding JSON object. Do not add any conversational text before or after the JSON.
            - **Google Search:** For requests like "search for X", "find information about Y".
              {"action": "google", "query": "[search term]", "response": "üëâ Is vishay par aur jaankari ke liye yahan click karein."}
            - **YouTube Search:** For requests like "find a video about X", "show me a YouTube video of Y".
              {"action": "youtube", "query": "[search term]", "response": "üëâ Is video ko dekhne ke liye yahan click karein."}
            - **WhatsApp Message:** For requests like "send a WhatsApp message to [number]".
              {"action": "whatsapp", "number": "[phone_number_with_country_code]", "message": "[message_to_send]", "response": "üëâ WhatsApp par message bhejne ke liye yahan click karein."}
            - **Phone Call:** For requests like "call [number]". If the user provides a name instead of a number, you MUST ask for the number first. Do not make up numbers.
              {"action": "call", "number": "[phone_number]", "response": "üëâ Call karne ke liye yahan click karein."}
            - **Image Generation:** If asked to create an image ("banao", "create", "generate image"), use this JSON: 
              {"action": "generate_image", "prompt": "[detailed image description]", "response": "Theek hai, main aapke liye yeh photo bana raha hoon... üé®"}

            **Code Formatting:**
            When you provide code in any language (e.g., HTML, CSS, JavaScript, Python), you MUST enclose it in markdown code fences with the language specified. For example:
            \`\`\`javascript
            console.log("Hello, World!");
            \`\`\``;
            
            const currentChatHistory = conversations[activeChatId]?.messages || [];
            const userPromptParts = [{ text: prompt }];
            if (fileData) {
                userPromptParts.push({
                    inlineData: {
                        mimeType: fileData.type,
                        data: fileData.base64
                    }
                });
            }

            const apiHistory = [ ...currentChatHistory, { role: "user", parts: userPromptParts } ];
            const payload = { contents: apiHistory, systemInstruction: { parts: [{ text: systemPrompt }] } };
            const response = await fetch('https://ravi-ai-i6h0.onrender.com/api/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            if (result.text) return result.text;
            throw new Error("Invalid API response structure.");
        }

        async function generateImage(prompt) {
            const enhancedPrompt = `${prompt}, 8k, photorealistic, highly detailed, professional photography, sharp focus, cinematic lighting`;
            const payload = { prompt: enhancedPrompt };
            const response = await fetch('https://ravi-ai-i6h0.onrender.com/api/generate-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Image generation failed with status ${response.status}`);
            const result = await response.json();
            if (result.base64Image) return result.base64Image;
            throw new Error("Invalid image response structure.");
        }
        
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({ base64: reader.result.split(',')[1], type: file.type, name: file.name });
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function setupEventListeners() {
            menuButton.addEventListener('click', toggleSidebar);
            collapseSidebarButton.addEventListener('click', toggleSidebar);
            
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = usernameInput.value.trim();
                const email = emailInput.value.trim();
                if (username && email) handleLogin(username, email);
            });
            
            guestLoginBtn.addEventListener('click', () => handleLogin('Guest'));
            
            googleLoginBtn.addEventListener('click', () => {
                auth.signInWithPopup(provider)
                    .then((result) => {
                        const user = result.user;
                        handleLogin(user.displayName, user.email);
                    }).catch((error) => {
                        console.error("Google Login Error:", error.message);
                        alert("Google login failed. Please check your Firebase configuration and make sure the domain is authorized.");
                    });
            });

            paymentButton.addEventListener('click', handlePayment);

            logoutButton.addEventListener('click', () => {
                auth.signOut().then(() => {
                    localStorage.clear();
                    currentUser = null;
                    currentUserEmail = null;
                    conversations = {};
                    activeChatId = null;
                    showLoginInterface();
                }).catch((error) => {
                    console.error("Logout Error:", error);
                     // Fallback for local-only logout
                    localStorage.clear();
                    showLoginInterface();
                });
            });

            newChatButton.addEventListener('click', startNewChat);
            muteButton.addEventListener('click', () => { isMuted = !isMuted; updateMuteButtonIcon(); if (isMuted) synth.cancel(); });
            themeToggleButton.addEventListener('click', () => { document.body.classList.toggle('light-theme'); localStorage.setItem('ravi-ai-theme', document.body.classList.contains('light-theme') ? 'light-theme' : ''); });
            
            chatSearchInput.addEventListener('input', renderChatHistory);

            chatHistoryList.addEventListener('click', (e) => {
                const chatButton = e.target.closest('button[data-chat-id]');
                const deleteButton = e.target.closest('button[data-chat-id-delete]');
                if (deleteButton) {
                    const chatIdToDelete = deleteButton.dataset.chatIdDelete;
                    delete conversations[chatIdToDelete];
                    saveConversations();
                    if (activeChatId === chatIdToDelete) {
                        const remaining = Object.keys(conversations);
                        if (remaining.length > 0) loadChat(remaining[remaining.length - 1]);
                        else startNewChat();
                    }
                    renderChatHistory();
                } else if (chatButton) {
                    loadChat(chatButton.dataset.chatId);
                }
            });

            optionsMenuButton.addEventListener('click', (e) => { e.stopPropagation(); optionsPopover.classList.toggle('hidden'); });
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectedFile = file;
                    filePreviewName.textContent = file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name;
                    filePreviewContainer.classList.remove('hidden');
                    optionsPopover.classList.add('hidden');
                }
                e.target.value = null;
            });

            createImageToggle.addEventListener('change', () => {
                userInput.placeholder = createImageToggle.checked ? "Aap kya photo banwana chahte hain?" : "Yahan type karein ya bolein...";
                optionsPopover.classList.add('hidden');
            });
            
            document.addEventListener('click', (e) => {
                if (!optionsPopover.classList.contains('hidden') && !optionsPopover.contains(e.target) && !optionsMenuButton.contains(e.target)) {
                    optionsPopover.classList.add('hidden');
                }
            });

            removeFileButton.addEventListener('click', () => { selectedFile = null; filePreviewContainer.classList.add('hidden'); });

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userMessage = userInput.value.trim();
                if (!userMessage && !selectedFile) return;
                synth.cancel();
                addMessageToUI('user', userMessage || `Analyzing file: ${selectedFile.name}`);
                userInput.value = '';
                typingIndicator.classList.remove('hidden');
                chatContainer.scrollTop = chatContainer.scrollHeight;
                if (createImageToggle.checked) {
                    createImageToggle.checked = false;
                    userInput.placeholder = "Yahan type karein ya bolein...";
                    addMessageToUI('model', "Theek hai, main aapke liye yeh photo bana raha hoon... üé®");
                    const imageBubble = addAILoadingBubble();
                    try {
                        const base64Image = await generateImage(userMessage);
                        renderGeneratedImage(imageBubble, `data:image/png;base64,${base64Image}`);
                    } catch (error) {
                        imageBubble.innerHTML = `<p class="text-red-400">Maaf kijiye, photo banane mein kuch samasya aa gayi.</p>`;
                    } finally {
                        typingIndicator.classList.add('hidden');
                    }
                    return;
                }
                let fileData = null;
                if (selectedFile) {
                    try { fileData = await readFileAsBase64(selectedFile); } 
                    catch (error) {
                        addMessageToUI('model', "Maaf kijiye, file padhne mein samasya aa gayi.");
                        typingIndicator.classList.add('hidden');
                        return;
                    }
                }
                addMessageToHistory('user', userMessage, selectedFile ? {name: selectedFile.name, type: selectedFile.type} : null);
                selectedFile = null;
                filePreviewContainer.classList.add('hidden');
                try {
                    const aiResponse = await getAIResponse(userMessage, fileData);
                    addMessageToHistory('model', aiResponse);
                    handleAIResponse(aiResponse);
                } catch (error) {
                    console.error("Error getting AI response:", error);
                    addMessageToUI('model', "Maaf kijiye, kuch takneeki samasya aa gayi hai.");
                } finally {
                    typingIndicator.classList.add('hidden');
                }
            });
            
            chatContainer.addEventListener('click', (e) => {
                const copyBtn = e.target.closest('.copy-btn');
                if (copyBtn) {
                    const textToCopy = copyBtn.closest('.message-bubble').querySelector('p').innerText;
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    copyBtn.innerHTML = `<svg class="h-4 w-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
                    setTimeout(() => {
                        copyBtn.innerHTML = `<svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
                    }, 1500);
                }
            });

            // Event listeners for modals
            privacyPolicyLink.addEventListener('click', (e) => {
                e.preventDefault();
                privacyModal.classList.remove('hidden');
            });
            termsOfServiceLink.addEventListener('click', (e) => {
                e.preventDefault();
                termsModal.classList.remove('hidden');
            });
            closePrivacyModal.addEventListener('click', () => {
                privacyModal.classList.add('hidden');
            });
            closeTermsModal.addEventListener('click', () => {
                termsModal.classList.add('hidden');
            });
            privacyModal.addEventListener('click', (e) => {
                if (e.target === privacyModal) {
                    privacyModal.classList.add('hidden');
                }
            });
            termsModal.addEventListener('click', (e) => {
                if (e.target === termsModal) {
                    termsModal.classList.add('hidden');
                }
            });
        }
        
        initialize();
    });
    </script>
</body>
</html>

